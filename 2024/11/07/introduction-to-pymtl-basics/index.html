<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Albert Cheung">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
        
        
        
            <link rel="preconnect" href="https://registry.npmmirror.com" crossorigin>
        
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2024/11/07/introduction-to-pymtl-basics/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="第01章 简介我们将在接下来的部分使用 PyMTL3 硬件建模框架进行功能级建模、验证以及模拟器的使用。可以选择 PyMTL3 或 Verilog 进行寄存器传输级建模，但即便使用 Verilog，也需完成本教程，因为课程中部分内容仍需使用 PyMTL3。需要注意的是，PyMTL3 是 PyMTL2 的改进版本，虽然二者在 API 上的差异不大，但 PyMTL3 在具体实现上有显著更新，因此需留意">
<meta property="og:type" content="article">
<meta property="og:title" content="PyMTL基础入门">
<meta property="og:url" content="http://example.com/2024/11/07/introduction-to-pymtl-basics/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="第01章 简介我们将在接下来的部分使用 PyMTL3 硬件建模框架进行功能级建模、验证以及模拟器的使用。可以选择 PyMTL3 或 Verilog 进行寄存器传输级建模，但即便使用 Verilog，也需完成本教程，因为课程中部分内容仍需使用 PyMTL3。需要注意的是，PyMTL3 是 PyMTL2 的改进版本，虽然二者在 API 上的差异不大，但 PyMTL3 在具体实现上有显著更新，因此需留意">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/image/24110701.png">
<meta property="og:image" content="http://example.com/image/24110702.png">
<meta property="og:image" content="http://example.com/image/24111001.png">
<meta property="og:image" content="http://example.com/image/24111102.jpg">
<meta property="og:image" content="http://example.com/image/24111301.png">
<meta property="og:image" content="http://example.com/image/24112501.png">
<meta property="og:image" content="http://example.com/image/24112502.png">
<meta property="og:image" content="http://example.com/image/24112503.png">
<meta property="og:image" content="http://example.com/image/24112504.png">
<meta property="og:image" content="http://example.com/image/24112001.png">
<meta property="og:image" content="http://example.com/image/24112002.png">
<meta property="og:image" content="http://example.com/image/24112003.png">
<meta property="og:image" content="http://example.com/image/24112101.png">
<meta property="og:image" content="http://example.com/image/24112102.png">
<meta property="article:published_time" content="2024-11-07T12:20:39.000Z">
<meta property="article:modified_time" content="2024-11-25T09:42:36.377Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Notes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/image/24110701.png">
    
    
        <!-- Google tag (gtag.js) -->
        <script src="https://www.googletagmanager.com/gtag/js?id=G-ZQ6EEL4C6N"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-ZQ6EEL4C6N');
        </script>
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/icons8-physics-24.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons8-physics-24.png">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/icons8-physics-24.png">
    <!--- Page Info-->
    
    <title>
        
            PyMTL基础入门 | Any%
        
    </title>

    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/fonts/Chillax/chillax.css">

    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/assets/build/styles.css">
    

    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/fonts/GeistMono/geist-mono.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/fonts/Geist/geist.css">
    <!--- Font Part-->
    
    
    
    
    
    
        <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/libs/anime.min.js" ></script>
    

    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":true,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":false,"post_pv":false},"single_page":true,"preloader":true,"open_graph":true,"google_analytics":{"enable":true,"id":"G-ZQ6EEL4C6N"}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/pillars_of_creation.webp","dark":"/images/pillars_of_creation.webp"},"title":"我们不只是星尘。","subtitle":{"text":["静止总有一丝响动，那是灵魂沉沉浮浮。","将您扼杀的就是您以为面前还有无尽的时间。","就这样将自己搁浅在夜的礁上，昨天已成过去，今天尚未开始。","雨天，我走进水坑里，不小心踩碎了天空。","把地球倒置，我用撒哈拉记时。","血液的作用之一，是为信仰付出代价。","人之所以言之凿凿，是因为知道的太少。","不要做永远都合群的人。做异见者，做一会儿孤松，独自度过漫长冬日。","水流是鱼的风。","无限风光在险峰。","在坚冰还覆盖着北海的时候，我看到了怒放的梅花。","于暴雨中行走，伞是倒划天空的船。"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"style":"default","links":{"github":"https://github.com/albertc9/","instagram":"https://www.instagram.com/albert_cheung9/","zhihu":null,"twitter":"https://x.com/albert_chg9/","email":"albert.chg9@gmail.com"},"qrs":{"weixin":"https://github.com/albertc9/albertc9.github.io/blob/main/image/QRcode.jpg?raw=true"}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.7.3","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"https://albertc9.github.io","icon":"fa-regular fa-house"},"Links":{"icon":"fa-regular fa-link","submenus":{"AMS&CEPC Twiki":"https://twiki.cern.ch/twiki/bin/view/Main/AMSCEPCDev","AMS Official Website":"https://ams02.space/","AMS Official Internal Website":"https://ams.cern.ch/","Web of Science":"https://www.webofscience.com","arXiv":"https://arxiv.org","D. Tong":"https://www.damtp.cam.ac.uk/user/tong/teaching.html"}}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"info","announcement":"Email：albert.chg9@gmail.com    WeChat Official Account：PyRLetter","show_on_mobile":true,"links":{"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"MMM D, YYYY","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/7/7 04:10:28"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/fontawesome/fontawesome.min.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/fontawesome/brands.min.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/fontawesome/solid.min.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/fontawesome/regular.min.css">
    
    
    
    
<meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



    <style>
    :root {
        --preloader-background-color: #fff;
        --preloader-text-color: #000;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --preloader-background-color: #202124;
            --preloader-text-color: #fff;
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --preloader-background-color: #fff;
            --preloader-text-color: #000;
        }
    }

    @media (max-width: 600px) {
        .ml13 {
            font-size: 2.6rem !important; /* Adjust this value as needed */
        }
    }

    .preloader {
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Tailwind 'gap-4' is 1rem */
        align-items: center;
        justify-content: center;
        position: fixed;
        padding: 12px;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh; /* 'h-screen' is 100% of the viewport height */
        background-color: var(--preloader-background-color);
        z-index: 1100; /* 'z-[1100]' sets the z-index */
        transition: opacity 0.2s ease-in-out;
    }

    .ml13 {
        font-size: 3.2rem;
        /* text-transform: uppercase; */
        color: var(--preloader-text-color);
        letter-spacing: -1px;
        font-weight: 500;
        font-family: 'Chillax-Variable', sans-serif;
        text-align: center;
    }

    .ml13 .word {
        display: inline-flex;
        flex-wrap: wrap;
        white-space: nowrap;
    }

    .ml13 .letter {
        display: inline-block;
        line-height: 1em;
    }
</style>

<div class="preloader">
    <h2 class="ml13">
        Any%
    </h2>
    <script>
        var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({ loop: true })
            .add({
                targets: '.ml13 .letter',
                translateY: [20, 0],
                translateZ: 0,
                opacity: [0, 1],
                filter: ['blur(5px)', 'blur(0px)'],
                easing: "easeOutExpo",
                duration: 1200,
                delay: (el, i) => 300 + 20 * i,
            })
            .add({
                targets: '.ml13 .letter',
                translateY: [0, -20],
                opacity: [1, 0],
                filter: ['blur(0px)', 'blur(5px)'],
                easing: "easeInExpo",
                duration: 1000,
                delay: (el, i) => 15 * i,
                complete: function() {
                    hidePreloader();
                }
            }, '-=700');


        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }
    </script>
</div>

<main class="page-container" id="swup">

    

    <div class="main-content-container flex flex-col justify-between min-h-dvh">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Any%
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   target="_blank" rel="noopener" href="https://albertc9.github.io"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown"
                                   href="#"
                                        onClick=&#34;return false;&#34;>
                                    <i class="fa-regular fa-link fa-fw"></i>
                                    LINKS
                                    <i class="fa-solid fa-chevron-down fa-fw"></i>
                                </a>

                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://twiki.cern.ch/twiki/bin/view/Main/AMSCEPCDev">
                                                    AMS&amp;CEPC TWIKI
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://ams02.space/">
                                                    AMS OFFICIAL WEBSITE
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://ams.cern.ch/">
                                                    AMS OFFICIAL INTERNAL WEBSITE
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://www.webofscience.com">
                                                    WEB OF SCIENCE
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://arxiv.org">
                                                    ARXIV
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://www.damtp.cam.ac.uk/user/tong/teaching.html">
                                                    D. TONG
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           target="_blank" rel="noopener" href="https://albertc9.github.io"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item-sub text-base my-1.5 flex flex-col w-full">
                        
                        <div class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary cursor-pointer text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                             navbar-data-toggle="submenu-Links"
                        >
                            <span>
                                LINKS
                            </span>
                            
                                <i class="fa-solid fa-chevron-right fa-sm fa-fw transition-all"></i>
                            
                        </div>
                        

                        
                            <div class="flex-col items-start px-2 py-2 hidden" data-target="submenu-Links">
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://twiki.cern.ch/twiki/bin/view/Main/AMSCEPCDev">AMS&amp;CEPC TWIKI</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://ams02.space/">AMS OFFICIAL WEBSITE</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://ams.cern.ch/">AMS OFFICIAL INTERNAL WEBSITE</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://www.webofscience.com">WEB OF SCIENCE</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://arxiv.org">ARXIV</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://www.damtp.cam.ac.uk/user/tong/teaching.html">D. TONG</a>
                                    </div>
                                
                            </div>
                        
                    </li>
            

            
            
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/tags"
                        >
                            <span>Tags</span>
                            <i class="fa-regular fa-tags fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/categories"
                        >
                            <span>Categories</span>
                            <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">3</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">10</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">38</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">PyMTL基础入门</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/avatar.JPG">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">Albert Cheung</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-11-07 20:20:39</span>
        <span class="mobile">2024-11-07 20:20:39</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-11-25 17:42:36</span>
            <span class="mobile">2024-11-25 17:42:36</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/Code-Basics/">Code Basics</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Notes/">Notes</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>21.7k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>89 Mins</span>
        </span>
    
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h2 id="第01章-简介"><a href="#第01章-简介" class="headerlink" title="第01章 简介"></a>第01章 简介</h2><p>我们将在接下来的部分使用 PyMTL3 硬件建模框架进行功能级建模、验证以及模拟器的使用。可以选择 PyMTL3 或 Verilog 进行寄存器传输级建模，但即便使用 Verilog，也需完成本教程，因为课程中部分内容仍需使用 PyMTL3。需要注意的是，PyMTL3 是 PyMTL2 的改进版本，虽然二者在 API 上的差异不大，但 PyMTL3 在具体实现上有显著更新，因此需留意这些变化。</p>
<p>本教程聚焦于 PyMTL3 框架的基本知识，包括开发、测试与评估方法，以及课程中使用的代码规范。涉及的开源工具包括：<strong>用于测试驱动开发的 pytest 框架，将 Verilog 转为 C++ 的 Verilator，以及用于查看波形的 GTKWave。</strong>PyMTL3 框架本身为开源项目，<a class="link" target="_blank" rel="noopener" href="https://github.com/pymtl/pymtl3">可在 GitHub 上访问 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，我们可以浏览其源码以深入了解框架的实现。</p>
<p>这里提供一个Fedora的建议安装流程（其他发行版类似）。</p>
<p>首先安装依赖项:</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install python3 python3-pip python3-venv</span><br></pre></td></tr></table></figure></div>

<p>推荐使用Conda创建一个虚拟环境，以便更好地管理依赖关系:</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh</span><br></pre></td></tr></table></figure></div>

<p>运行下载的安装脚本，并按照提示安装：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash Miniconda3-latest-Linux-x86_64.sh</span><br></pre></td></tr></table></figure></div>

<p>完成安装后，初始化 Conda，以便在终端中可以直接使用 <code>conda</code> 命令：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/miniconda3/bin/activate</span><br><span class="line">conda init</span><br></pre></td></tr></table></figure></div>

<p>在 Conda 安装完成并配置后，您可以创建一个新的环境，用于安装和运行 PyMTL3。使用以下命令创建名为 <code>pymtl3_env</code> 的环境，同时指定 Python 版本：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda create -n pymtl3_env python=3.8</span><br></pre></td></tr></table></figure></div>

<p>创建环境后，使用以下命令激活 <code>pymtl3_env</code> 环境：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda activate pymtl3_env</span><br></pre></td></tr></table></figure></div>

<p>安装PyMTL3:</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pymtl3</span><br></pre></td></tr></table></figure></div>

<p>如果您还需要 Verilator（例如进行 RTL 级仿真），可以从 Fedora 的包管理器中安装:</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install verilator</span><br></pre></td></tr></table></figure></div>

<h2 id="第02章-PyMTL3-的功能级、周期级和寄存器传输级建模"><a href="#第02章-PyMTL3-的功能级、周期级和寄存器传输级建模" class="headerlink" title="第02章 PyMTL3 的功能级、周期级和寄存器传输级建模"></a>第02章 PyMTL3 的功能级、周期级和寄存器传输级建模</h2><p>计算机架构师可以在不同抽象级别上对系统进行建模，包括<strong>功能级（Functional-Level, FL）</strong>、<strong>周期级（Cycle-Level, CL）</strong>和<strong>寄存器传输级（Register-Transfer-Level, RTL）</strong>。每个建模级别都有其独特的优缺点，因此有效的设计通常需要综合利用这些不同的建模级别。未来将通过示例展示如何从 FL 到 CL 再到 RTL 逐步优化设计，尽管在实验作业中主要集中于 FL 和 RTL 建模。</p>
<h3 id="2-1-FL、CL-和-RTL-建模比较"><a href="#2-1-FL、CL-和-RTL-建模比较" class="headerlink" title="2.1 FL、CL 和 RTL 建模比较"></a>2.1 FL、CL 和 RTL 建模比较</h3><ul>
<li>功能级 (FL)：实现硬件功能而不关注时序。FL 模型适用于探索算法、快速仿真目标硬件和创建黄金模型来验证 CL 和 RTL 模型。这种模型构建简单，但与目标硬件的准确性最低。FL可以看作是算法模拟器，用来快速验证算法或目标硬件的功能是否正确。因为 FL 模型不考虑硬件的时序，因此仿真速度快，构建也相对简单，但它不能精确地代表硬件的实际行为。它通常用于编写“黄金模型”，即参考模型，用来验证其他更精确模型的正确性。</li>
<li>周期级 (CL)：捕捉硬件目标的近似周期行为，通过在功能行为上增加时序模型来追踪硬件性能，适用于在不同微架构参数下快速探索设计空间。CL 模型在准确性、性能和灵活性之间取得平衡。</li>
<li>寄存器传输级 (RTL)：提供周期、资源和位级精确的硬件表示，主要用于特定硬件实现的验证和综合。RTL 模型是最为详细的建模方式，适用于驱动 EDA 工具流以估算面积、能耗和时序，但构建较为复杂。</li>
</ul>
<p>在本教程中，FL、CL 和 RTL 模型都使用基于端口的接口、并发模块和结构化组合的方式。此外，PyMTL3 支持高级多态接口连接，允许不同级别的接口通过自动插入适配器进行直接连接。这种基于端口和多态的方式支持 PyMTL3 的混合级别建模，即可以将 FL、CL 和 RTL 模型组合成一个统一的系统模型。</p>
<h3 id="2-2-可综合与非可综合-RTL-建模"><a href="#2-2-可综合与非可综合-RTL-建模" class="headerlink" title="2.2 可综合与非可综合 RTL 建模"></a>2.2 可综合与非可综合 RTL 建模</h3><p>由于 PyMTL3 嵌入在 Python 中（Python 是一种通用编程语言），<em>可以非常容易地编写无法模拟实际硬件的 PyMTL3 代码</em>，而这对于构建 FL 模型、测试框架、断言和行跟踪等功能是必需的。因此，学生在建模时必须谨慎选择自己编写的是可综合的 RTL 模型还是非可综合代码，时刻明确自己在模拟什么样的硬件以及如何模拟。</p>
<p>学生的设计任务几乎完全使用可综合的 PyMTL3 RTL 模型。可以在 <code>update_ff</code>、<code>update</code> 和 <code>update_once</code> 并发模块之外的 Python 代码（即展开代码）中使用任何 Python 代码，因为<em>展开代码用于生成硬件而不是实际建模硬件</em>。在并发模块中可适量包含非可综合代码用于调试、断言或行跟踪，但应通过注释标记这些非可综合代码，以便自动化工具在综合设计前将其移除。</p>
<p>下面包含了一个表格，列出了哪些 Python 结构在可综合的 PyMTL3 并发模块中允许使用、有限制地允许使用以及显式禁止使用的结构。与 ECE 4750 不同，这些规则仅作为建议。我们可以使用 PyMTL3 可翻译成 Verilog 且 Synopsys Design Compiler 可综合的任何内容。如果发现更高级的语法可以简化设计且可被综合，亦可采用该语法。</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24110701.png" alt="1"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24110702.png" alt="2"></p>
<h2 id="第03章-PyMTL3基础：数据类型和操作符"><a href="#第03章-PyMTL3基础：数据类型和操作符" class="headerlink" title="第03章 PyMTL3基础：数据类型和操作符"></a>第03章 PyMTL3基础：数据类型和操作符</h2><p>从本章开始，我们将从基本内容开始，写一些非常基础的代码来介绍PyMTL3的基础数据类型和操作符。我们通过</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure></div>

<p>在Python的开头来导入PyMTL3框架。</p>
<h3 id="3-1-Bits数据类型"><a href="#3-1-Bits数据类型" class="headerlink" title="3.1 Bits数据类型"></a>3.1 Bits数据类型</h3><p>在硬件建模框架 PyMTL3 中，Bits 类用于表示固定位宽的值。与许多硬件描述语言 (HDL) 支持四态值（0, 1, X, Z，其中 X 表示未知值，Z 表示高阻抗值）不同，PyMTL3 的 Bits 仅支持二态值（0 和 1）。虽然这种设计可以加速仿真并避免 X 值带来的问题，但也增加了描述一些硬件结构的复杂度。此外，在仅支持二态值的环境下处理复位逻辑可能会有一定挑战，但可以通过已知的技术加以解决。</p>
<h4 id="3-1-1-创建与操作-Bits-对象"><a href="#3-1-1-创建与操作-Bits-对象" class="headerlink" title="3.1.1 创建与操作 Bits 对象"></a>3.1.1 创建与操作 Bits 对象</h4><p>以下示例展示了如何在 Python 中实例化和操作 Bits 对象：</p>
<ul>
<li>BitsN 构造函数用于创建固定位宽的 Bits 对象。<code>Bits16(37)</code> 表示创建一个 16 位宽的 Bits 对象，并赋初值为 37。</li>
<li>在 PyMTL3 中，位宽在 1 至 255 位之间的常用 Bits 类型已经定义。也可以通过 <code>mk_bits(N)</code> 动态创建更宽的 Bits 类型。</li>
</ul>
<p>例如：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits16(<span class="number">37</span>)  <span class="comment"># 创建 16 位宽、初值为 37 的 Bits 对象</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(a)  </span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">'pymtl3.datatypes.bits_import.Bits16'</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">Bits16(<span class="number">0x0025</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>(a)</span><br><span class="line"><span class="string">'0025'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(a), a</span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">'int'</span>&gt;, <span class="number">47</span>)</span><br></pre></td></tr></table></figure></div>


<h4 id="3-1-2-常量、负数与进制支持"><a href="#3-1-2-常量、负数与进制支持" class="headerlink" title="3.1.2 常量、负数与进制支持"></a>3.1.2 常量、负数与进制支持</h4><ul>
<li>常量创建：可以通过 bN 语法创建常量，如 <code>b16(37)</code>。</li>
</ul>
<p><strong>请注意：这里的<code>BitsN</code>都是2进制的位宽，而非N进制的位宽</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>b16(<span class="number">37</span>)</span><br><span class="line">Bits16(<span class="number">0x0025</span>)</span><br></pre></td></tr></table></figure></div>

<ul>
<li>进制表示：Bits 支持二进制和十六进制表示，如 <code>Bits8(0b10101100)</code> 和 <code>Bits32(0xabcd0123)</code>。其中：<ul>
<li>二进制（Binary） - 0b 前缀</li>
</ul>
</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Bits8( <span class="number">0b10101100</span> )</span><br><span class="line">Bits8(<span class="number">0xac</span>)</span><br></pre></td></tr></table></figure></div>
<ul>
<li>八进制（Octal） - 0o 前缀</li>
<li>十进制（Decimal） - 无前缀</li>
<li>十六进制（Hexadecimal） - 0x 前缀</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Bits32(<span class="number">0xabcd0123</span>)</span><br><span class="line">Bits32(<span class="number">0xabcd0123</span>)</span><br></pre></td></tr></table></figure></div>
<ul>
<li>负值：Bits 对象可存储负数，采用二进制补码表示，例如 <code>Bits8(-1)</code> 将存储为 <code>0xff</code>。</li>
<li>动态范围检查：当赋值超出位宽允许的范围时，Bits 构造函数将抛出异常。例如，<code>Bits8(260)</code> 将会报错，因为 260 无法用 8 位表示。可以通过以下方式实现：</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Bits260</span><br><span class="line">NameError: name <span class="string">'Bits260'</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>N = <span class="number">260</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>BitsN = mk_bits(<span class="number">260</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>BitsN(<span class="number">37</span>)</span><br><span class="line">Bits260(<span class="number">0x0000000</span>..<span class="number">.0000025</span>)</span><br></pre></td></tr></table></figure></div>

<ul>
<li>截断初值：可以通过 <code>trunc_int=True</code> 参数来截断过大的初值值，如 <code>Bits8(0xdeadbeef, trunc_int=True)</code> 将返回 <code>Bits8(0xef)</code>。</li>
</ul>
<h4 id="3-1-3-获取位宽与数值"><a href="#3-1-3-获取位宽与数值" class="headerlink" title="3.1.3 获取位宽与数值"></a>3.1.3 获取位宽与数值</h4><p>可以使用 <code>nbits</code> 属性获取 Bits 对象的位宽，<code>uint()</code> 方法获取无符号整数值，<code>int()</code> 方法获取有符号整数值。例如：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits8(<span class="number">128</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.nbits</span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.uint()</span><br><span class="line"><span class="number">128</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.<span class="built_in">int</span>()</span><br><span class="line">-<span class="number">128</span></span><br></pre></td></tr></table></figure></div>

<h4 id="3-1-4-位切片与复制"><a href="#3-1-4-位切片与复制" class="headerlink" title="3.1.4 位切片与复制"></a>3.1.4 位切片与复制</h4><ul>
<li>位切片：Bits 对象可以像 Python 列表一样进行位切片以读取或写入特定位段。切片语法 [start:end] 包含 start 位、不包含 end 位。例如，<code>a[28:32]</code> 表示获取 a 的高四位。</li>
</ul>
<p>示例：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits32(<span class="number">0xabcd0123</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a[<span class="number">28</span>:<span class="number">32</span>]</span><br><span class="line">Bits4(<span class="number">0xa</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a[<span class="number">4</span>:<span class="number">24</span>]</span><br><span class="line">Bits20(<span class="number">0xcd012</span>)</span><br></pre></td></tr></table></figure></div>

<p>在这段代码中，我们对一个 Bits32 对象进行了位切片：</p>
<ol>
<li><p>a[28:32]：提取 a 的最高 4 位（第 28 位至第 31 位），返回一个 4 位的 Bits4 对象。</p>
<ul>
<li>在 0xabcd0123 中，最高 4 位是 0xa（二进制为 1010）。</li>
<li>所以，a[28:32] 返回 Bits4(0xa)。</li>
</ul>
</li>
<li><p>a[4:24]：提取 a 从第 4 位到第 23 位的位段，共 20 位，返回一个 Bits20 对象。</p>
<ul>
<li>在 0xabcd0123 中，从第 4 位到第 23 位对应的二进制是 0b11001101000000010010，即 0xcd012。</li>
<li>因此，a[4:24] 返回 Bits20(0xcd012)。</li>
</ul>
</li>
</ol>
<p><strong>请注意：由于N是2进制的位宽，因此位切片也是在2进制下进行的。例如：</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">位索引:    <span class="number">31</span> <span class="number">30</span> <span class="number">29</span> <span class="number">28</span> <span class="number">27</span> <span class="number">26</span> <span class="number">25</span> <span class="number">24</span> <span class="number">23</span> <span class="number">22</span> <span class="number">21</span> <span class="number">20</span> <span class="number">19</span> <span class="number">18</span> <span class="number">17</span> <span class="number">16</span> <span class="number">15</span> <span class="number">14</span> <span class="number">13</span> <span class="number">12</span> <span class="number">11</span> <span class="number">10</span>  <span class="number">9</span>  <span class="number">8</span>  <span class="number">7</span>  <span class="number">6</span>  <span class="number">5</span>  <span class="number">4</span>  <span class="number">3</span>  <span class="number">2</span>  <span class="number">1</span>  <span class="number">0</span></span><br><span class="line">二进制值:   <span class="number">1</span>  <span class="number">0</span>  <span class="number">1</span>  <span class="number">0</span>  <span class="number">1</span>  <span class="number">0</span>  <span class="number">1</span>  <span class="number">1</span>  <span class="number">1</span>  <span class="number">1</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">1</span>  <span class="number">1</span>  <span class="number">0</span>  <span class="number">1</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">1</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">1</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">1</span>  <span class="number">1</span></span><br><span class="line">十六进制:    a     b     c     d     <span class="number">0</span>     <span class="number">1</span>     <span class="number">2</span>     <span class="number">3</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>修改位段：通过赋值可以修改特定位段的值，例如，<code>a[28:32] = 0xf</code> 将高四位修改为 <code>f</code>。</li>
<li>复制对象：直接赋值并不会复制 Bits 对象，而是<strong>创建引用</strong>。若想复制 Bits 对象，需要显式创建新对象。例如，<code>b = Bits32(a)</code> 会创建 <code>a</code> 的副本，之后对 <code>a</code> 或 <code>b</code> 的修改不会影响对方。例如：</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits32( <span class="number">0xabcd0123</span> )</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = a</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">Bits32(<span class="number">0xabcd0123</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b</span><br><span class="line">Bits32(<span class="number">0xabcd0123</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a[<span class="number">24</span>:<span class="number">32</span>] = <span class="number">0x67</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">Bits32(<span class="number">0x67cd0123</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b</span><br><span class="line">Bits32(<span class="number">0x67cd0123</span>)</span><br></pre></td></tr></table></figure></div>

<p>而</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits32( <span class="number">0xabcd0123</span> )</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = Bits32( a )</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">Bits32(<span class="number">0xabcd0123</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b</span><br><span class="line">Bits32(<span class="number">0xabcd0123</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a[<span class="number">24</span>:<span class="number">32</span>] = <span class="number">0x67</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">Bits32(<span class="number">0x67cd0123</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b</span><br><span class="line">Bits32(<span class="number">0xabcd0123</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="3-2-Bits操作符-Bits-Operators"><a href="#3-2-Bits操作符-Bits-Operators" class="headerlink" title="3.2 Bits操作符(Bits Operators)"></a>3.2 Bits操作符(Bits Operators)</h3><h4 id="3-2-1-支持的操作符"><a href="#3-2-1-支持的操作符" class="headerlink" title="3.2.1 支持的操作符"></a>3.2.1 支持的操作符</h4><p>PyMTL3 中的 Bits 对象支持多种操作符，分为以下几类：</p>
<ul>
<li>逻辑操作符：包括按位与 <code>&amp;</code>、按位或 <code>|</code>、按位异或 <code>^</code> 和按位非 <code>~</code>。</li>
<li>算术操作符：支持加法 <code>+</code>、减法 <code>-</code> 和乘法 <code>*</code>。</li>
<li>缩减操作符：包括 <code>reduce_and</code>（按位与缩减）、<code>reduce_or</code>（按位或缩减）和 <code>reduce_xor</code>（按位异或缩减），这些操作符会将 Bits 对象缩减为单个位宽。</li>
<li>移位操作符：支持右移 <code>&gt;&gt;</code> 和左移 <code>&lt;&lt;</code>。</li>
<li>关系操作符：包括相等 <code>==</code>、不等 <code>!=</code>、大于 <code>&gt;</code>、大于或等于 <code>&gt;=</code>、小于 <code>&lt;</code> 和小于或等于 <code>&lt;=</code>。</li>
</ul>
<p>其他函数：</p>
<ul>
<li><code>sext</code>：符号扩展。</li>
<li><code>zext</code>：零扩展。</li>
<li><code>concat</code>：连接多个 Bits 对象。</li>
</ul>
<p><strong>注意：Python 还支持其他一些操作符（如除法 <code>/</code> 和取模 <code>%</code>），但在 PyMTL3 的 RTL 模型中这些操作符不可翻译，因此应避免使用。</strong></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24111001.png" alt="24111001"></p>
<h4 id="3-2-2-操作符使用示例"><a href="#3-2-2-操作符使用示例" class="headerlink" title="3.2.2 操作符使用示例"></a>3.2.2 操作符使用示例</h4><p>逻辑与缩减操作符：可以对 Bits 对象执行逻辑运算。PyMTL3 支持自动将整数隐式转换为 Bits 对象，但如果两个 Bits 对象的位宽不同，会导致类型不匹配错误。可通过 <code>sext</code> 或 <code>zext</code> 扩展位宽，以匹配操作数的位宽。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits4(<span class="number">0b1010</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = Bits4(<span class="number">0b1100</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a &amp; b</span><br><span class="line">Bits4(<span class="number">0x8</span>)  <span class="comment"># 0b1000</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a | b</span><br><span class="line">Bits4(<span class="number">0xe</span>) <span class="comment"># 0b1110</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a ^ b</span><br><span class="line">Bits4(<span class="number">0x6</span>) <span class="comment"># 0b110</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>~ a</span><br><span class="line">Bits4(<span class="number">0x5</span>) <span class="comment"># 0b0101</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>sext</code>（符号扩展，symbol extend）：符号扩展用于将带符号的数值扩展到更高的位宽。如果原始值是负数（即最高有效位为1），符号扩展会在扩展的高位填充1；如果是正数，则填充0。这种扩展方法适用于有符号数的操作。</li>
<li><code>zext</code>（零扩展，zero extend）：零扩展用于将无符号数扩展到更高的位宽，扩展时在高位补零。适用于无符号数的操作。</li>
</ul>
<p>例如：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits4(<span class="number">0b1010</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a &amp; Bits5(<span class="number">0b1100</span>)</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"/afs/ihep.ac.cn/users/z/zhanglikai/.local/lib/python3.9/site-packages/pymtl3/datatypes/PythonBits.py"</span>, line <span class="number">269</span>, <span class="keyword">in</span> __and__</span><br><span class="line">    <span class="keyword">raise</span> ValueError( <span class="string">f"Operands of '&amp;' (and) operation must have matching bitwidth, "</span>\</span><br><span class="line">ValueError: Operands of <span class="string">'&amp;'</span> (<span class="keyword">and</span>) operation must have matching bitwidth, but here Bits4 != Bits5.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = zext(a, <span class="number">5</span>) </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a &amp; Bits5(<span class="number">0b1100</span>) </span><br><span class="line">Bits5(<span class="number">0x08</span>) <span class="comment"># 0b1000</span></span><br></pre></td></tr></table></figure></div>

<p>移位操作符：支持逻辑左移和右移。移位的位数可以是整数或 Bits 对象，右移时高位用零填充，移位结果的位宽与操作数的位宽一致。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits4(<span class="number">0b1011</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a &lt;&lt; <span class="number">2</span></span><br><span class="line">Bits4(<span class="number">0xc</span>) <span class="comment"># 0b1100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits4(<span class="number">0b1011</span>)  <span class="comment"># 4 位的二进制数 1011</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a &gt;&gt; <span class="number">2</span>  <span class="comment"># 将 a 右移 2 位</span></span><br><span class="line">Bits4(<span class="number">0x2</span>) <span class="comment"># 0b0010</span></span><br></pre></td></tr></table></figure></div>

<p>算术操作符：加法和减法操作的结果位宽为操作数位宽的最大值，支持模运算并采用二进制补码表示负数。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits4(<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a + <span class="number">2</span></span><br><span class="line">Bits4(<span class="number">0x5</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a + <span class="number">15</span></span><br><span class="line">Bits4(<span class="number">0x2</span>) <span class="comment"># 4位宽截断</span></span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits4(-<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">Bits4(<span class="number">0xe</span>)</span><br></pre></td></tr></table></figure></div>

<p>关系操作符：支持比较两个 Bits 对象，结果为单个位宽的 Bits 对象，比较操作默认将操作数视为无符号整数。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits4(<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = Bits4(<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a &gt; b</span><br><span class="line">Bits1(<span class="number">0x1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a == b</span><br><span class="line">Bits1(<span class="number">0x0</span>)</span><br></pre></td></tr></table></figure></div>

<p>其他函数：</p>
<ul>
<li>连接：<code>concat</code> 可将多个 Bits 对象连接成一个新对象。</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits8(<span class="number">0xab</span>) </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = Bits12(<span class="number">0xcde</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>concat(a, b)  </span><br><span class="line">Bits20(<span class="number">0xabcde</span>) <span class="comment"># 由于分别是16进制和2进制，所以直接拼接</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>concat(b, a) </span><br><span class="line">Bits20(<span class="number">0xcdeab</span>)</span><br></pre></td></tr></table></figure></div>

<ul>
<li>截断：<code>trunc</code> 可将 Bits 对象截断为较小的位宽（只取低N位）。</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Bits8(<span class="number">0xff</span>) <span class="comment"># 0b11111111</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>trunc(a, <span class="number">3</span>) </span><br><span class="line">Bits3(<span class="number">0x7</span>) <span class="comment"># 0b111</span></span><br></pre></td></tr></table></figure></div>


<h3 id="3-3-BitStruct-数据类型"><a href="#3-3-BitStruct-数据类型" class="headerlink" title="3.3 BitStruct 数据类型"></a>3.3 BitStruct 数据类型</h3><p>BitStruct 是 PyMTL3 中用于定义带有命名位字段的结构体类型，这些字段具有固定的位宽。通过 BitStruct，可以将多种数据字段组合成一个紧凑的 Bits 对象，并为这些字段赋予便于访问和操作的名称。</p>
<h4 id="3-3-1-创建-BitStruct"><a href="#3-3-1-创建-BitStruct" class="headerlink" title="3.3.1 创建 BitStruct"></a>3.3.1 创建 BitStruct</h4><p>在 PyMTL3 中，使用 <code>@bitstruct</code> 装饰器定义 BitStruct 类，这类似于 Python 3.7 引入的 dataclass。以下是一个定义 Point 的示例，它表示一个二维点，包括 x 和 y 两个四位的字段：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bitstruct</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span>:</span><br><span class="line">    x: Bits4</span><br><span class="line">    y: Bits4</span><br></pre></td></tr></table></figure></div>

<p>创建 Point 实例时，可以直接赋值并访问各字段：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pt1 = Point(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(pt1.x)  <span class="comment"># 输出 Bits4(0x3)</span></span><br><span class="line"><span class="built_in">print</span>(pt1.y)  <span class="comment"># 输出 Bits4(0x4)</span></span><br></pre></td></tr></table></figure></div>

<h4 id="3-3-2-转换与打包"><a href="#3-3-2-转换与打包" class="headerlink" title="3.3.2 转换与打包"></a>3.3.2 转换与打包</h4><ul>
<li>打包为 Bits 对象：使用 <code>to_bits()</code> 方法可以将 BitStruct 实例打包为一个 Bits 对象，方便在更大的位结构中使用。此方法从最高有效位开始打包。</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt1.to_bits()  <span class="comment"># 输出 Bits8(0x34)，按高位优先顺序</span></span><br></pre></td></tr></table></figure></div>


<ul>
<li>解包为 BitStruct 实例：可以通过 <code>from_bits</code> 方法将 Bits 对象解包为 BitStruct 实例：</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Point.from_bits(Bits8(<span class="number">0x34</span>))  <span class="comment"># 返回 Point(Bits4(0x3), Bits4(0x4))</span></span><br></pre></td></tr></table></figure></div>


<h4 id="3-3-3-参数化的-BitStruct"><a href="#3-3-3-参数化的-BitStruct" class="headerlink" title="3.3.3 参数化的 BitStruct"></a>3.3.3 参数化的 BitStruct</h4><p>在某些情况下，字段的位宽可能在运行时才确定。PyMTL3 提供了 <code>mk_bitstruct</code> 函数，支持在运行时定义具有指定位宽的 BitStruct。例如，这是固定位宽的Point结构体：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>@bitstruct</span><br><span class="line"><span class="meta">... </span><span class="keyword">class</span> <span class="title class_">Point</span>:</span><br><span class="line"><span class="meta">... </span>    x: Bits4 <span class="comment"># 注意tab</span></span><br><span class="line"><span class="meta">... </span>    y: Bits4</span><br><span class="line"><span class="meta">... </span><span class="comment"># 直接换行保存退出</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>pt1 = Point(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>pt1</span><br><span class="line">Point(Bits4(<span class="number">0x3</span>),Bits4(<span class="number">0x4</span>))</span><br></pre></td></tr></table></figure></div>

<p>这是带参数化位宽的Point结构体。在运行时定义一个新的 PointN 结构体，使得 x 和 y 字段的位宽可以根据需要动态设置。这里使用 mk_bitstruct 函数，生成一个包含两个 nbits 位宽字段的 Point8 结构体：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>nbits = <span class="number">8</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>PointN = mk_bitstruct(<span class="string">f"Point<span class="subst">{nbits}</span>"</span>, {</span><br><span class="line"><span class="meta">... </span>    <span class="string">'x'</span>: mk_bits(nbits),</span><br><span class="line"><span class="meta">... </span>    <span class="string">'y'</span>: mk_bits(nbits),</span><br><span class="line"><span class="meta">... </span>})</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>pt2 = PointN(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>pt2</span><br><span class="line">Point8(Bits8(<span class="number">0x03</span>),Bits8(<span class="number">0x04</span>))</span><br></pre></td></tr></table></figure></div>

<h2 id="第04章-寄存增量器-Registered-Incrementer"><a href="#第04章-寄存增量器-Registered-Incrementer" class="headerlink" title="第04章 寄存增量器(Registered Incrementer)"></a>第04章 寄存增量器(Registered Incrementer)</h2><p>在本节中，我们将构建一个基本的 PyMTL3 硬件模型，学习如何模拟、可视化、验证、复用、参数化并封装此模型。我们将以一个8位加1器（Registered Incrementer）为例进行建模。好的设计实践是，在开始编码之前，先绘制硬件模型的图示，例如数据通路图、状态机图或控制信号表，这样可以确保模型准确反映设计意图。</p>
<p><strong>请注意：使用两空格缩进，且仅使用空格避免混淆，而不是tab。</strong></p>
<h3 id="4-1-建模寄存增量器"><a href="#4-1-建模寄存增量器" class="headerlink" title="4.1 建模寄存增量器"></a>4.1 建模寄存增量器</h3><p>我们设计一个8位加1器模型。该模型具有一个 8 位输入端口和一个 8 位输出端口。每个时钟上升沿，输入值会被寄存，并加 1 后输出。在下方拆解示例代码：</p>
<p>首先，从 PyMTL3 框架中导入所需内容，并定义 <code>RegIncr</code> 类继承自 <code>Component</code> 基类：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RegIncr</span>(<span class="title class_ inherited__">Component</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">construct</span>(<span class="params">s</span>):</span><br></pre></td></tr></table></figure></div>

<ul>
<li>Component 是 PyMTL3 模型的基类。</li>
<li>通过 construct 方法定义端口接口、内部信号和并发逻辑块。</li>
</ul>
<p>声明输入和输出端口：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s.in_ = InPort(Bits8)</span><br><span class="line">s.out = OutPort(Bits8)</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>s.in_</code> 是 8 位输入端口（<strong>用 in_ 而不是 in，因为 in 是 Python 的保留字</strong>）。</li>
<li><code>s.out</code> 是 8 位输出端口。</li>
<li>PyMTL3 模型中不需要显式定义时钟 <code>clk</code> 和复位 <code>reset</code> 端口，它们是隐含的输入。</li>
</ul>
<p>定义一个 8 位的内部信号 <code>reg_out</code>，用于存储寄存器的输出：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s.reg_out = Wire(<span class="number">8</span>)</span><br></pre></td></tr></table></figure></div>

<p><code>Wire</code> 用于在并发块间传递数据，是一种内部信号。</p>
<p>使用 <code>update_ff</code> 装饰器定义寄存器逻辑，模拟寄存器的行为。<code>update_ff</code> 块在每个时钟上升沿调用一次，用于在寄存器中存储数据：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@update_ff</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">block1</span>():</span><br><span class="line">    <span class="keyword">if</span> s.reset:</span><br><span class="line">        s.reg_out &lt;&lt;= <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s.reg_out &lt;&lt;= s.in_</span><br></pre></td></tr></table></figure></div>

<ul>
<li>在 PyMTL3 中，<code>update_ff</code> 是一个特殊的装饰器，用来定义依赖时钟上升沿触发的逻辑块（我们称为“<strong>同步逻辑块</strong>”）。也就是说，<code>update_ff</code> 块会在每个时钟上升沿被调用一次。</li>
<li><code>s.reset</code> 用于判断复位信号。如果复位，<code>reg_out</code> 置为 0；否则，将输入端口的值赋给 <code>reg_out</code>。</li>
<li>使用 <code>&lt;&lt;=</code> 操作符来实现非阻塞赋值，使得所有 <code>update_ff</code> 块在同一个时钟周期内看起来是并行执行的，这意味着即使我们在多个 <code>update_ff</code> 块中对信号进行赋值，这些赋值都会在当前时钟周期结束后才真正生效。</li>
</ul>
<details class="[red]" data-header-exclude=""><summary><i class="fa-solid fa-chevron-right"></i>[为什么需要非阻塞赋值？] </summary>
              <div class="content">
              <p>在硬件电路中，多个寄存器和逻辑单元通常会在同一个时钟信号的控制下更新状态。如果使用阻塞赋值，当一个寄存器的值改变时，它会立即影响到依赖它的其他逻辑单元，从而导致电路在同一个时钟周期内产生不同步的更新，最终产生竞态条件或不稳定的行为。</p><p>非阻塞赋值的优点在于，它允许我们在时钟周期内并行更新多个寄存器的值，而不受彼此的影响。这样可以确保电路在每个时钟周期的边界上达到稳定状态，从而避免竞态和不稳定的情况。只需要参考该例：</p><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@update_ff</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">block</span>():</span><br><span class="line">    A = B + <span class="number">1</span>  <span class="comment"># 立即更新 A 的值</span></span><br><span class="line">    B = A + <span class="number">2</span>  <span class="comment"># 使用 A 的新值来更新 B 的值</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@update_ff</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">block</span>():</span><br><span class="line">    A &lt;&lt;= B + <span class="number">1</span>  <span class="comment"># 非阻塞赋值，延迟到整个块执行完毕后更新</span></span><br><span class="line">    B &lt;&lt;= A + <span class="number">2</span>  <span class="comment"># 非阻塞赋值，延迟到整个块执行完毕后更新</span></span><br></pre></td></tr></table></figure></div>
              </div>
            </details>

<p>然后，使用 <code>update</code> 装饰器定义递增逻辑，用于将 <code>reg_out</code> 的值加 1 并输出：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@update</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">block2</span>():</span><br><span class="line">    s.out @= s.reg_out + <span class="number">1</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>update</code> 表示组合逻辑块，响应信号的变化而立即更新。</li>
<li>使用 <code>@=</code> 操作符进行阻塞赋值，使更新立即生效。</li>
<li>每次 <code>reg_out</code> 值变化时，<code>block2</code> 将被触发，读取 <code>reg_out</code> 的值并加 1 后赋给 <code>s.out</code>。</li>
</ul>
<p>在 PyMTL3 中，复位信号（<code>reset</code>）只能在 <code>update_ff</code> 块中读取（同步复位），不能在 <code>update</code> 块中使用。如果需要在组合逻辑中利用复位信息，应通过复位信号初始化状态位，然后在组合逻辑中读取该状态位。</p>
<p>以下是完整的8位加1器的代码实现：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RegIncr</span>(<span class="title class_ inherited__">Component</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">construct</span>(<span class="params">s</span>):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 端口接口</span></span><br><span class="line">        s.in_ = InPort(Bits8)</span><br><span class="line">        s.out = OutPort(Bits8)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 内部信号</span></span><br><span class="line">        s.reg_out = Wire(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 寄存器逻辑</span></span><br><span class="line"><span class="meta">        @update_ff</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">block1</span>():</span><br><span class="line">            <span class="keyword">if</span> s.reset:</span><br><span class="line">                s.reg_out &lt;&lt;= <span class="number">0</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                s.reg_out &lt;&lt;= s.in_</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 递增逻辑</span></span><br><span class="line"><span class="meta">        @update</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">block2</span>():</span><br><span class="line">            s.out @= s.reg_out + <span class="number">1</span></span><br></pre></td></tr></table></figure></div>

<p>简单的工作流程如下：</p>
<ol>
<li>寄存器更新：每个时钟上升沿，<code>block1</code> 被调用，将 <code>in_</code> 的值存储到 <code>reg_out</code>。</li>
<li>递增逻辑：<code>reg_out</code> 值发生变化后，<code>block2</code> 立即被调用，读取 <code>reg_out</code> 的值，加 1 后赋给 <code>out</code>。</li>
<li>上述过程在每个时钟周期重复执行。</li>
</ol>
<h3 id="4-2-模拟模型"><a href="#4-2-模拟模型" class="headerlink" title="4.2 模拟模型"></a>4.2 模拟模型</h3><p>在创建了硬件模型后，我们可以通过编写一个模拟脚本来测试其功能。以下内容展示了如何使用一个简单的 Python 脚本来展开模型，创建模拟器，写入输入值并显示输入/输出端口的值。</p>
<p>首先，我们编写脚本 <code>regincr-sim</code>，它从命令行接收输入值，对 <code>RegIncr</code> 模型进行模拟，并输出各时钟周期的输入和输出值。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#=========================================================================</span></span><br><span class="line"><span class="comment"># regincr-sim &lt;input-values&gt;</span></span><br><span class="line"><span class="comment">#=========================================================================</span></span><br><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line"><span class="keyword">from</span> RegIncr <span class="keyword">import</span> RegIncr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从命令行获取输入值列表</span></span><br><span class="line">input_values = [<span class="built_in">int</span>(x, <span class="number">0</span>) <span class="keyword">for</span> x <span class="keyword">in</span> argv[<span class="number">1</span>:]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在输入值列表末尾添加三个零值，以便模拟多几个周期，方便观察输出</span></span><br><span class="line">input_values.extend([<span class="number">0</span>] * <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">model = RegIncr()</span><br><span class="line">model.elaborate()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用默认的通用 Pass 组以添加模拟功能</span></span><br><span class="line">model.apply(DefaultPassGroup())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置模拟器</span></span><br><span class="line">model.sim_reset()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入值应用与输出值显示</span></span><br><span class="line"><span class="keyword">for</span> input_value <span class="keyword">in</span> input_values:</span><br><span class="line">    model.in_ @= input_value</span><br><span class="line">    model.sim_eval_combinational()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 显示当前周期的输入与输出</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"cycle = <span class="subst">{model.sim_cycle_count()}</span>: in = <span class="subst">{model.in_}</span>, out = <span class="subst">{model.out}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 模拟器前进一个周期</span></span><br><span class="line">    model.sim_tick()</span><br></pre></td></tr></table></figure></div>

<p>每个输入值经过以下几个步骤：</p>
<ol>
<li>写入输入端口：使用 <code>@=</code> 操作符将 <code>input_value</code> 写入模型的 <code>in_</code> 端口。这里 <code>@=</code> 的使用类似于 <code>update</code> 块中的信号写入，以确保值立即生效。</li>
<li>组合逻辑求值：调用 <code>model.sim_eval_combinational()</code> 以评估组合逻辑，更新输出值。</li>
<li>输出显示：调用 <code>print</code> 输出当前周期计数、输入值和输出值。</li>
<li>前进一个周期：调用 <code>model.sim_tick()</code>，模拟器进入下一个时钟周期。</li>
</ol>
<p>由于 <code>sim_reset</code> 方法将复位信号激活了两个周期，输出从第 3 周期开始显示。当新输入值写入递增器时，在下一个周期即可观察到对应的递增输出值。</p>
<p>以下是运行结果：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Line Tracing</span></span><br><span class="line">(pymtl3_env) (usr) albert@alberts-fedora:~/CSC/cpt4$ python regincr-sim.py 0x01 0x13 0x25 0x37</span><br><span class="line">cycle = 3: <span class="keyword">in</span> = 01, out = 01</span><br><span class="line">cycle = 4: <span class="keyword">in</span> = 13, out = 02</span><br><span class="line">cycle = 5: <span class="keyword">in</span> = 25, out = 14</span><br><span class="line">cycle = 6: <span class="keyword">in</span> = 37, out = 26</span><br><span class="line">cycle = 7: <span class="keyword">in</span> = 00, out = 38</span><br><span class="line">cycle = 8: <span class="keyword">in</span> = 00, out = 01</span><br><span class="line">cycle = 9: <span class="keyword">in</span> = 00, out = 01</span><br></pre></td></tr></table></figure></div>

<h3 id="4-3-可视化"><a href="#4-3-可视化" class="headerlink" title="4.3 可视化"></a>4.3 可视化</h3><p>在设计的早期阶段，通过行跟踪 (line tracing) 可以调试设计的高级行为。然而，当我们需要查看更多信号的细节时，仅依靠行跟踪显得不够直观。PyMTL3 框架可以输出 VCD（Value Change Dump） 格式的波形文件，记录设计中每个信号（包括端口和内部信号）的变化，以便我们在工具中查看波形。</p>
<h4 id="4-3-1-GTKwave"><a href="#4-3-1-GTKwave" class="headerlink" title="4.3.1 GTKwave"></a>4.3.1 GTKwave</h4><p>在 regincr-sim 脚本中，可以通过为 <code>DefaultPassGroup</code> 传递 <code>vcdwave</code> 参数来启用 VCD 输出。该参数指定生成的 VCD 文件的名称（无需添加 <code>.vcd</code> 后缀）：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.apply(DefaultPassGroup(vcdwave=<span class="string">'regincr-sim'</span>))</span><br></pre></td></tr></table></figure></div>

<p>这行代码将配置 <code>DefaultPassGroup</code> 来生成名为 regincr-sim.vcd 的 VCD 文件。</p>
<p>在终端中执行以下命令以运行模拟脚本，并生成波形文件：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ${TUTROOT}/tut3_pymtl/regincr</span><br><span class="line">./regincr-sim <span class="number">0x01</span> <span class="number">0x13</span> <span class="number">0x25</span> <span class="number">0x37</span></span><br></pre></td></tr></table></figure></div>

<p>这将根据输入数据运行模拟并生成 regincr-sim.vcd 文件。文件生成后，可以使用开源工具 GTKWave 来浏览波形：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gtkwave regincr-sim.vcd &amp;</span><br></pre></td></tr></table></figure></div>

<p>可以通过 GTKWave 的<a class="link" target="_blank" rel="noopener" href="https://gtkwave.sourceforge.net/gtkwave.pdf">官方文档 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>了解更多实用功能。</p>
<p>这是输出的结果：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24111102.jpg" alt="24111102"></p>
<h4 id="4-3-2-基于文本的波形"><a href="#4-3-2-基于文本的波形" class="headerlink" title="4.3.2 基于文本的波形"></a>4.3.2 基于文本的波形</h4><p>有时没有必要总是使用图形界面工具如 GTKWave 查看 VCD 文件查看，因为它涉及启动图形界面，尤其在远程服务器上可能会耗费较长时间。因此，在一些小规模设计或简单测试中，我们可以采用<strong>基于文本的波形</strong>查看方式。这种方式可以在终端内直接展示信号的变化，适用于少数周期的快速调试。</p>
<p>和前面相似，在 <code>regincr-sim</code> 脚本中，我们可以通过为 <code>DefaultPassGroup</code> 传递 <code>textwave=True</code> 参数来启用文本波形输出。还需要在模拟循环结束后调用 <code>print_textwave</code> 方法来打印波形。PyMTL3 设计上不会在模拟进行中自动输出文本波形，因此需要手动调用以便在模拟结束后统一输出：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.apply(DefaultPassGroup(textwave=<span class="literal">True</span>))</span><br></pre></td></tr></table></figure></div>

<p>在结束循环后调用：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.print_textwave()</span><br></pre></td></tr></table></figure></div>

<p>这是输出结果：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">(pymtl3_env) (usr) albert@alberts-fedora:~/CSC/cpt4$ python regincr-sim.py <span class="number">0x01</span> <span class="number">0x10</span> <span class="number">0x15</span> <span class="number">0x17</span></span><br><span class="line">cycle = <span class="number">3</span>: <span class="keyword">in</span> = 01, out = 01</span><br><span class="line"></span><br><span class="line">        |<span class="number">0</span>    |<span class="number">1</span>    |<span class="number">2</span>    |<span class="number">3</span>    </span><br><span class="line"></span><br><span class="line">    clk /‾‾\__/‾‾\__/‾‾\__/‾‾\__</span><br><span class="line"></span><br><span class="line">  reset ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\_____</span><br><span class="line"></span><br><span class="line">    in_  <span class="number">00</span>               |01   </span><br><span class="line"></span><br><span class="line">    out  01                     </span><br><span class="line"></span><br><span class="line">reg_out  <span class="number">00</span>                     </span><br><span class="line"></span><br><span class="line">cycle = <span class="number">4</span>: <span class="keyword">in</span> = <span class="number">10</span>, out = 02</span><br><span class="line"></span><br><span class="line">        |<span class="number">0</span>    |<span class="number">1</span>    |<span class="number">2</span>    |<span class="number">3</span>    |<span class="number">4</span>    </span><br><span class="line"></span><br><span class="line">    clk /‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__</span><br><span class="line"></span><br><span class="line">  reset ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\___________</span><br><span class="line"></span><br><span class="line">    in_  <span class="number">00</span>               |01   |<span class="number">10</span>   </span><br><span class="line"></span><br><span class="line">    out  01                     |02   </span><br><span class="line"></span><br><span class="line">reg_out  <span class="number">00</span>                     |01   </span><br><span class="line"></span><br><span class="line">cycle = <span class="number">5</span>: <span class="keyword">in</span> = <span class="number">15</span>, out = <span class="number">11</span></span><br><span class="line"></span><br><span class="line">        |<span class="number">0</span>    |<span class="number">1</span>    |<span class="number">2</span>    |<span class="number">3</span>    |<span class="number">4</span>    |<span class="number">5</span>    </span><br><span class="line"></span><br><span class="line">    clk /‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__</span><br><span class="line"></span><br><span class="line">  reset ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\_________________</span><br><span class="line"></span><br><span class="line">    in_  <span class="number">00</span>               |01   |<span class="number">10</span>   |<span class="number">15</span>   </span><br><span class="line"></span><br><span class="line">    out  01                     |02   |<span class="number">11</span>   </span><br><span class="line"></span><br><span class="line">reg_out  <span class="number">00</span>                     |01   |<span class="number">10</span>   </span><br><span class="line"></span><br><span class="line">cycle = <span class="number">6</span>: <span class="keyword">in</span> = <span class="number">17</span>, out = <span class="number">16</span></span><br><span class="line"></span><br><span class="line">        |<span class="number">0</span>    |<span class="number">1</span>    |<span class="number">2</span>    |<span class="number">3</span>    |<span class="number">4</span>    |<span class="number">5</span>    |<span class="number">6</span>    </span><br><span class="line"></span><br><span class="line">    clk /‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__</span><br><span class="line"></span><br><span class="line">  reset ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\_______________________</span><br><span class="line"></span><br><span class="line">    in_  <span class="number">00</span>               |01   |<span class="number">10</span>   |<span class="number">15</span>   |<span class="number">17</span>   </span><br><span class="line"></span><br><span class="line">    out  01                     |02   |<span class="number">11</span>   |<span class="number">16</span>   </span><br><span class="line"></span><br><span class="line">reg_out  <span class="number">00</span>                     |01   |<span class="number">10</span>   |<span class="number">15</span>   </span><br><span class="line"></span><br><span class="line">cycle = <span class="number">7</span>: <span class="keyword">in</span> = <span class="number">00</span>, out = <span class="number">18</span></span><br><span class="line"></span><br><span class="line">        |<span class="number">0</span>    |<span class="number">1</span>    |<span class="number">2</span>    |<span class="number">3</span>    |<span class="number">4</span>    |<span class="number">5</span>    |<span class="number">6</span>    |<span class="number">7</span>    </span><br><span class="line"></span><br><span class="line">    clk /‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__</span><br><span class="line"></span><br><span class="line">  reset ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\_____________________________</span><br><span class="line"></span><br><span class="line">    in_  <span class="number">00</span>               |01   |<span class="number">10</span>   |<span class="number">15</span>   |<span class="number">17</span>   |<span class="number">00</span>   </span><br><span class="line"></span><br><span class="line">    out  01                     |02   |<span class="number">11</span>   |<span class="number">16</span>   |<span class="number">18</span>   </span><br><span class="line"></span><br><span class="line">reg_out  <span class="number">00</span>                     |01   |<span class="number">10</span>   |<span class="number">15</span>   |<span class="number">17</span>   </span><br><span class="line"></span><br><span class="line">cycle = <span class="number">8</span>: <span class="keyword">in</span> = <span class="number">00</span>, out = 01</span><br><span class="line"></span><br><span class="line">        |<span class="number">0</span>    |<span class="number">1</span>    |<span class="number">2</span>    |<span class="number">3</span>    |<span class="number">4</span>    |<span class="number">5</span>    |<span class="number">6</span>    |<span class="number">7</span>    |<span class="number">8</span>    </span><br><span class="line"></span><br><span class="line">    clk /‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__</span><br><span class="line"></span><br><span class="line">  reset ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\___________________________________</span><br><span class="line"></span><br><span class="line">    in_  <span class="number">00</span>               |01   |<span class="number">10</span>   |<span class="number">15</span>   |<span class="number">17</span>   |<span class="number">00</span>         </span><br><span class="line"></span><br><span class="line">    out  01                     |02   |<span class="number">11</span>   |<span class="number">16</span>   |<span class="number">18</span>   |01   </span><br><span class="line"></span><br><span class="line">reg_out  <span class="number">00</span>                     |01   |<span class="number">10</span>   |<span class="number">15</span>   |<span class="number">17</span>   |<span class="number">00</span>   </span><br><span class="line"></span><br><span class="line">cycle = <span class="number">9</span>: <span class="keyword">in</span> = <span class="number">00</span>, out = 01</span><br><span class="line"></span><br><span class="line">        |<span class="number">0</span>    |<span class="number">1</span>    |<span class="number">2</span>    |<span class="number">3</span>    |<span class="number">4</span>    |<span class="number">5</span>    |<span class="number">6</span>    |<span class="number">7</span>    |<span class="number">8</span>    |<span class="number">9</span>    </span><br><span class="line"></span><br><span class="line">    clk /‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__/‾‾\__</span><br><span class="line"></span><br><span class="line">  reset ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\_________________________________________</span><br><span class="line"></span><br><span class="line">    in_  <span class="number">00</span>               |01   |<span class="number">10</span>   |<span class="number">15</span>   |<span class="number">17</span>   |<span class="number">00</span>               </span><br><span class="line"></span><br><span class="line">    out  01                     |02   |<span class="number">11</span>   |<span class="number">16</span>   |<span class="number">18</span>   |01         </span><br><span class="line"></span><br><span class="line">reg_out  <span class="number">00</span>                     |01   |<span class="number">10</span>   |<span class="number">15</span>   |<span class="number">17</span>   |<span class="number">00</span></span><br></pre></td></tr></table></figure></div>

<p>这是实际在终端中的输出结果示例：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24111301.png" alt="24111301"></p>
<h3 id="4-4-使用pytest进行单元测试验证模型"><a href="#4-4-使用pytest进行单元测试验证模型" class="headerlink" title="4.4 使用pytest进行单元测试验证模型"></a>4.4 使用pytest进行单元测试验证模型</h3><h4 id="4-4-1-pytest框架简介"><a href="#4-4-1-pytest框架简介" class="headerlink" title="4.4.1 pytest框架简介"></a>4.4.1 pytest框架简介</h4><p>在开发硬件模型后，验证其功能正确性是至关重要的环节。仅通过观察行跟踪（line trace）或波形文件来判断设计是否正确是一种“肉眼验证”的方式，容易出错且不具备可重复性。随着设计的复杂度增加，手动检查的方式变得不可行。因此，通过自动化单元测试，可以更严谨、系统化地验证模型的功能，并且在修改设计或进行团队协作时，也能更轻松地复现测试过程。</p>
<p>在本课程中，我们使用 pytest 框架进行单元测试，它提供了强大的功能，包括自动发现测试、参数化测试、丰富的报错信息、标准输出捕获等。pytest 使用非常简便，同时允许我们根据需求编写简单或复杂的测试。</p>
<p>pytest 框架拥有以下特点，非常适合硬件设计的测试：</p>
<ul>
<li>自动：pytest 会自动寻找以 <code>test_</code> 开头的函数，认为它们是测试用例。</li>
<li>标准断言语句：使用标准的 <code>assert</code> 语句来检查预期值和实际值，无需额外学习专用的测试库函数。</li>
<li>命令行参数控制：支持参数化命令行控制，如生成 VCD 文件、设置输出捕获等。</li>
<li>报错：当断言失败时，pytest 会提供详细的上下文信息，包括变量值和函数调用栈，帮助快速定位问题。</li>
</ul>
<p>以下代码展示了如何为 8 位加 1 器编写单元测试，并对模型的行为进行验证：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pymtl3.stdlib.test_utils <span class="keyword">import</span> config_model_with_cmdline_opts</span><br><span class="line"><span class="keyword">from</span> ..RegIncr <span class="keyword">import</span> RegIncr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_basic</span>(<span class="params">cmdline_opts</span>):</span><br><span class="line">    model = RegIncr()</span><br><span class="line">    model = config_model_with_cmdline_opts(model, cmdline_opts, duts=[])</span><br><span class="line"></span><br><span class="line">    model.apply(DefaultPassGroup(linetrace=<span class="literal">True</span>))</span><br><span class="line">    model.sim_reset()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">t</span>(<span class="params">in_, out</span>):</span><br><span class="line">        model.in_ @= in_</span><br><span class="line">        model.sim_eval_combinational()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> out != <span class="string">'?'</span>:</span><br><span class="line">            <span class="keyword">assert</span> model.out == out</span><br><span class="line"></span><br><span class="line">        model.sim_tick()</span><br><span class="line"></span><br><span class="line">    t(<span class="number">0x00</span>, <span class="string">'?'</span>)</span><br><span class="line">    t(<span class="number">0x13</span>, <span class="number">0x01</span>)</span><br><span class="line">    t(<span class="number">0x27</span>, <span class="number">0x14</span>)</span><br><span class="line">    t(<span class="number">0x00</span>, <span class="number">0x28</span>)</span><br><span class="line">    t(<span class="number">0x00</span>, <span class="number">0x01</span>)</span><br><span class="line">    t(<span class="number">0x00</span>, <span class="number">0x01</span>)</span><br></pre></td></tr></table></figure></div>

<p><strong>代码解析:</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">model = RegIncr()</span><br><span class="line">model = config_model_with_cmdline_opts(model, cmdline_opts, duts=[])</span><br></pre></td></tr></table></figure></div>

<p>使用 <code>config_model_with_cmdline_opts</code> 函数配置模型，<code>cmdline_opts</code> 收集命令行参数，如 <code>--dump-vcd</code>，用于控制是否生成 VCD 文件。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">model.apply(DefaultPassGroup(linetrace=<span class="literal">True</span>))</span><br><span class="line">model.sim_reset()</span><br></pre></td></tr></table></figure></div>

<p>DefaultPassGroup 的 <code>linetrace=True</code> 选项启用了行跟踪输出，<code>sim_reset</code> 重置模拟器，使得模型处于初始状态。</p>
<p>然后，定义辅助函数 <code>t</code>：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">t</span>(<span class="params">in_, out</span>):</span><br><span class="line">    model.in_ @= in_</span><br><span class="line">    model.sim_eval_combinational()</span><br><span class="line">    <span class="keyword">if</span> out != <span class="string">'?'</span>:</span><br><span class="line">        <span class="keyword">assert</span> model.out == out</span><br><span class="line">    model.sim_tick()</span><br></pre></td></tr></table></figure></div>

<p>辅助函数 <code>t</code> 定义了一个单周期的测试，参数 <code>in_</code> 表示输入值，<code>out</code> 表示期望输出值：</p>
<ul>
<li>将 <code>in_</code> 写入输入端口。</li>
<li>调用 <code>sim_eval_combinational</code> 来评估组合逻辑，更新输出。</li>
<li>如果 <code>out</code> 不等于 <code>?</code>，表示需要验证输出值，通过 <code>assert</code> 语句进行检查。</li>
<li>使用 <code>sim_tick</code> 模拟器前进一个时钟周期。</li>
</ul>
<p>测试用例定义：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">t(<span class="number">0x00</span>, <span class="string">'?'</span>)    <span class="comment"># 第一个周期，不关心输出值</span></span><br><span class="line">t(<span class="number">0x13</span>, <span class="number">0x01</span>)   <span class="comment"># 第二个周期，输入值 0x13，期望输出为 0x14</span></span><br><span class="line">t(<span class="number">0x27</span>, <span class="number">0x14</span>)   <span class="comment"># 第三个周期，验证输入值 0x27</span></span><br><span class="line">t(<span class="number">0x00</span>, <span class="number">0x28</span>)   <span class="comment"># 第四个周期，期望输出 0x28</span></span><br><span class="line">t(<span class="number">0x00</span>, <span class="number">0x01</span>)   <span class="comment"># 第五个周期，输出值为 0x01</span></span><br><span class="line">t(<span class="number">0x00</span>, <span class="number">0x01</span>)   <span class="comment"># 第六个周期，输出值保持 0x01</span></span><br></pre></td></tr></table></figure></div>

<p>每个周期的输入和期望输出在函数 <code>t</code> 中定义。通过这种逐周期的测试方法，可以精确地验证每个周期的输入输出关系。</p>
<p>这是实际输出结果示例（如果出现报错，可尝试降低pytest版本至7.2.0通过<code>pip install pytest==7.2.0</code>）：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(pymtl3_env) (usr) albert@alberts-fedora:~/CSC/cpt4$ pytest RegIncr_test.py</span><br><span class="line">======================================== <span class="built_in">test</span> session starts =========================================</span><br><span class="line">platform linux -- Python 3.8.20, pytest-7.2.0, pluggy-1.5.0</span><br><span class="line">rootdir: /home/albert/CSC/cpt4</span><br><span class="line">plugins: hypothesis-6.113.0, pymtl3-3.1.16</span><br><span class="line">collected 1 item                                                                                     </span><br><span class="line"></span><br><span class="line">RegIncr_test.py .                                                                              [100%]</span><br><span class="line"></span><br><span class="line">========================================= 1 passed <span class="keyword">in</span> 0.69s ==========================================</span><br></pre></td></tr></table></figure></div>

<h4 id="4-4-2-运行测试脚本"><a href="#4-4-2-运行测试脚本" class="headerlink" title="4.4.2 运行测试脚本"></a>4.4.2 运行测试脚本</h4><p>将测试脚本 <code>RegIncr_test.py</code> 放置在目录中。pytest 会自动发现以 <code>_test.py</code> 结尾的文件并运行其中的测试用例。建议在单独的构建目录中运行测试，以避免生成文件混杂：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> <span class="variable">${TUTROOT}</span>/build</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">${TUTROOT}</span>/build</span><br><span class="line">pytest ../tut3_pymtl/regincr/test/RegIncr_test.py</span><br></pre></td></tr></table></figure></div>

<p>执行结果显示每个测试脚本和测试函数的通过情况，每个通过的测试用例会显示一个“<code>.</code>”，失败的测试用例会显示“<code>F</code>”。</p>
<h4 id="4-4-3-使用pytest命令行选项"><a href="#4-4-3-使用pytest命令行选项" class="headerlink" title="4.4.3 使用pytest命令行选项"></a>4.4.3 使用pytest命令行选项</h4><p><code>--capture=no</code> 选项：默认情况下，pytest 会捕获标准输出。若希望在终端中查看行跟踪信息，可以通过 <code>--capture=no</code> 选项禁用输出捕获：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pytest ../tut3_pymtl/regincr/test/RegIncr_test.py --capture=no</span><br></pre></td></tr></table></figure></div>

<p><code>--tb</code>选项：当测试失败时，可以通过 <code>--tb</code> 参数调整错误输出的详细程度。<code>--tb=short</code> 会输出简短的错误信息，而 <code>--tb=long</code> 会输出完整的调用栈信息：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pytest ../tut3_pymtl/regincr/test/RegIncr_test.py --tb=short</span><br><span class="line">pytest ../tut3_pymtl/regincr/test/RegIncr_test.py --tb=long</span><br></pre></td></tr></table></figure></div>

<p><code>--dump-vcd</code>选项：如果需要生成 VCD 文件以便于在波形查看工具中进一步分析，可以在运行 pytest 时使用 <code>--dump-vcd</code> 选项。生成的 VCD 文件将包含测试的信号波形：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pytest ../tut3_pymtl/regincr/test/RegIncr_test.py --dump-vcd</span><br><span class="line">gtkwave tut3_pymtl.regincr.test.RegIncr_test__test_basic.vcd &amp;</span><br></pre></td></tr></table></figure></div>


<h3 id="4-5-使用测试向量验证模型"><a href="#4-5-使用测试向量验证模型" class="headerlink" title="4.5 使用测试向量验证模型"></a>4.5 使用测试向量验证模型</h3><p>在硬件设计的单元测试中，通常需要多个定向测试用例来验证设计的不同方面。简单地重复写测试代码不仅冗长，还容易出错。为了简化测试代码，PyMTL3 提供了 <code>run_test_vector_sim</code> 辅助函数，允许通过<strong>测试向量（test vectors）</strong>的形式进行验证。这种方法将输入和期望输出以表格的方式展示，使得测试代码简洁清晰。</p>
<h4 id="4-5-1-run-test-vector-sim-函数简介"><a href="#4-5-1-run-test-vector-sim-函数简介" class="headerlink" title="4.5.1 run_test_vector_sim 函数简介"></a>4.5.1 <code>run_test_vector_sim</code> 函数简介</h4><p><code>run_test_vector_sim</code> 是 PyMTL3 标准库中的一部分，用于简化基于测试向量的单元测试。这一函数的作用是：</p>
<ul>
<li>自动展开模型并创建模拟器。</li>
<li>重置模拟器并写入测试向量表中的输入值。</li>
<li>读取模型输出并与测试向量表中的参考输出值进行比较。</li>
</ul>
<p><strong>测试向量表</strong>是一个二维列表，每一行表示一个时钟周期的输入输出关系：</p>
<ul>
<li>第一行是表头，列出了端口名称。输出端口名以<code>*</code>标识。</li>
<li>每一列对应一个输入或期望输出值。</li>
<li>每一行（从第二行开始）对应一个模拟周期的输入输出。<code>?</code> 表示我们不关心该周期的输出值。</li>
</ul>
<p>以下示例展示了如何使用 <code>run_test_vector_sim</code> 对 8 位加 1 器模型进行三个测试：小输入值、大输入值以及溢出情况。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pymtl3.stdlib.test_utils <span class="keyword">import</span> run_test_vector_sim</span><br><span class="line"><span class="keyword">from</span> ..RegIncr <span class="keyword">import</span> RegIncr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试小输入值</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_small</span>(<span class="params">cmdline_opts</span>):</span><br><span class="line">    run_test_vector_sim(RegIncr(), [</span><br><span class="line">        (<span class="string">'in_ out*'</span>),</span><br><span class="line">        [ <span class="number">0x00</span>, <span class="string">'?'</span> ],   <span class="comment"># 第一个周期，我们不关心输出</span></span><br><span class="line">        [ <span class="number">0x03</span>, <span class="number">0x01</span> ],  <span class="comment"># 输入 0x03，期望输出 0x01（上个周期递增 1）</span></span><br><span class="line">        [ <span class="number">0x06</span>, <span class="number">0x04</span> ],  <span class="comment"># 输入 0x06，期望输出 0x04</span></span><br><span class="line">        [ <span class="number">0x00</span>, <span class="number">0x07</span> ],  <span class="comment"># 输入 0x00，期望输出 0x07</span></span><br><span class="line">    ], cmdline_opts)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试大输入值</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_large</span>(<span class="params">cmdline_opts</span>):</span><br><span class="line">    run_test_vector_sim(RegIncr(), [</span><br><span class="line">        (<span class="string">'in_ out*'</span>),</span><br><span class="line">        [ <span class="number">0xa0</span>, <span class="string">'?'</span> ],   <span class="comment"># 输入较大值，第一周期不关心输出</span></span><br><span class="line">        [ <span class="number">0xb3</span>, <span class="number">0xa1</span> ],  <span class="comment"># 输入 0xb3，期望输出 0xa1</span></span><br><span class="line">        [ <span class="number">0xc6</span>, <span class="number">0xb4</span> ],  <span class="comment"># 输入 0xc6，期望输出 0xb4</span></span><br><span class="line">        [ <span class="number">0x00</span>, <span class="number">0xc7</span> ],  <span class="comment"># 输入 0x00，期望输出 0xc7</span></span><br><span class="line">    ], cmdline_opts)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试溢出情况</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_overflow</span>(<span class="params">cmdline_opts</span>):</span><br><span class="line">    run_test_vector_sim(RegIncr(), [</span><br><span class="line">        (<span class="string">'in_ out*'</span>),</span><br><span class="line">        [ <span class="number">0x00</span>, <span class="string">'?'</span> ],   <span class="comment"># 第一个周期，不关心输出</span></span><br><span class="line">        [ <span class="number">0xfe</span>, <span class="number">0x01</span> ],  <span class="comment"># 输入 0xfe，期望输出 0x01（0xfe + 1 = 0xff，下一周期回到 0x01）</span></span><br><span class="line">        [ <span class="number">0xff</span>, <span class="number">0xff</span> ],  <span class="comment"># 输入 0xff，递增至溢出，保持 0xff</span></span><br><span class="line">        [ <span class="number">0x00</span>, <span class="number">0x00</span> ],  <span class="comment"># 输入 0x00，重置输出为 0x00</span></span><br><span class="line">    ], cmdline_opts)</span><br></pre></td></tr></table></figure></div>

<p>代码解析:</p>
<ul>
<li><code>test_small</code> 函数：<strong>测试小输入值情况</strong>，输入从 <code>0x00, 0x03, 0x06, 0x00</code> 开始，期望输出为 <code>?, 0x01, 0x04, 0x07</code>，以验证递增器的基本功能。</li>
<li><code>test_large</code> 函数：<strong>测试大输入值情况</strong>，输入从 <code>0xa0, 0xb3, 0xc6, 0x00</code> 开始，期望输出为 <code>?, 0xa1, 0xb4, 0xc7</code>，用于验证递增器对大输入值的处理。</li>
<li><code>test_overflow</code> 函数：<strong>测试溢出情况</strong>，输入从 <code>0x00, 0xfe, 0xff, 0x00</code> 开始，期望输出为 <code>?, 0x01, 0xff, 0x00</code>，用于检查递增器的溢出处理逻辑。</li>
</ul>
<h4 id="4-5-2-运行测试脚本"><a href="#4-5-2-运行测试脚本" class="headerlink" title="4.5.2 运行测试脚本"></a>4.5.2 运行测试脚本</h4><p>将测试脚本 RegIncr_extra_test.py 放置在目录中。可以在 build 目录下运行以下命令来执行测试脚本：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">${TUTROOT}</span>/build</span><br><span class="line">pytest ../tut3_pymtl/regincr/test/RegIncr_extra_test.py</span><br></pre></td></tr></table></figure></div>

<p>测试结果将显示每个测试函数的通过情况，成功的测试用例以 <code>.</code> 表示。此测试脚本可以自动发现并运行所有包含 _test.py 后缀的文件中的测试用例。这是输出结果：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(pymtl3_env) (usr) albert@alberts-fedora:~/CSC/cpt4$ pytest RegIncr_extra_test.py </span><br><span class="line">======================================== <span class="built_in">test</span> session starts =========================================</span><br><span class="line">platform linux -- Python 3.8.20, pytest-7.2.0, pluggy-1.5.0</span><br><span class="line">rootdir: /home/albert/CSC/cpt4</span><br><span class="line">plugins: hypothesis-6.113.0, pymtl3-3.1.16</span><br><span class="line">collected 3 items                                                                                    </span><br><span class="line"></span><br><span class="line">RegIncr_extra_test.py ...                                                                      [100%]</span><br><span class="line"></span><br><span class="line">========================================= 3 passed <span class="keyword">in</span> 0.80s ==========================================</span><br></pre></td></tr></table></figure></div>

<h4 id="4-5-3-使用-pytest-命令行选项"><a href="#4-5-3-使用-pytest-命令行选项" class="headerlink" title="4.5.3 使用 pytest 命令行选项"></a>4.5.3 使用 pytest 命令行选项</h4><ul>
<li><code>-v</code> 选项：用于显示详细输出，列出每个测试用例的执行结果。</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pytest ../tut3_pymtl/regincr/test -v</span><br></pre></td></tr></table></figure></div>


<ul>
<li><code>-k</code> 选项：可以用于选择运行特定名称的测试用例。例如，运行名称包含 small 的测试用例。</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pytest ../tut3_pymtl/regincr/test -k small</span><br></pre></td></tr></table></figure></div>


<ul>
<li><code>-x</code> 选项：在遇到第一个失败的测试用例时停止运行。</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pytest ../tut3_pymtl/regincr/test -x</span><br></pre></td></tr></table></figure></div>


<h4 id="4-5-4-三步调试法"><a href="#4-5-4-三步调试法" class="headerlink" title="4.5.4 三步调试法"></a>4.5.4 三步调试法</h4><p>当测试一个目录中的所有测试用例时，可以采用三步调试法逐步缩小问题范围：</p>
<ol>
<li>运行所有测试：获取当前目录下所有测试用例的总体执行情况，了解哪些测试通过，哪些失败。</li>
</ol>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pytest ../tut3_pymtl/regincr/test/</span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li>查看详细输出：使用 <code>-v</code> 选项运行单个测试脚本，观察失败的具体测试用例。</li>
</ol>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pytest ../tut3_pymtl/regincr/test/RegIncr2stage_test.py -v</span><br></pre></td></tr></table></figure></div>

<ol start="3">
<li>逐步调试：结合 <code>-x</code>、<code>-k</code>、<code>--tb=short</code> 等选项，进一步缩小调试范围，定位问题。</li>
</ol>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pytest ../tut3_pymtl/regincr/test/RegIncr2stage_test.py -v -x --tb=short</span><br></pre></td></tr></table></figure></div>

<h3 id="4-6-使用随机测试验证模型"><a href="#4-6-使用随机测试验证模型" class="headerlink" title="4.6 使用随机测试验证模型"></a>4.6 使用随机测试验证模型</h3><p>在前面的测试中，我们采用了定向逐周期灰盒测试策略，手动设计了特定的输入输出来验证模型的功能。然而，除了手工编写的定向测试外，随机测试也能有效提高验证的覆盖率和测试的严谨性。通过随机生成输入值，能帮助发现手动测试难以察觉的潜在错误。</p>
<p>Python 提供的 <code>random</code> 模块可以方便地生成随机输入值，<strong>但在使用随机测试时需要注意模型的延迟，确保每个期望的输出值出现在正确的周期位置上</strong>。以下是一个适用于8位加1器模型的随机测试用例示例。</p>
<p>以下代码展示了如何生成随机测试向量表，并利用 <code>run_test_vector_sim</code> 函数来进行随机测试：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pymtl3.stdlib.test_utils <span class="keyword">import</span> run_test_vector_sim</span><br><span class="line"><span class="keyword">from</span> RegIncr <span class="keyword">import</span> RegIncr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试随机输入值</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_random</span>(<span class="params">cmdline_opts</span>):</span><br><span class="line">    <span class="comment"># 初始化测试向量表，表头定义输入/输出端口</span></span><br><span class="line">    test_vector_table = [(<span class="string">'in_'</span>, <span class="string">'out*'</span>)]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 初始化上一个周期的期望输出</span></span><br><span class="line">    last_result = <span class="string">'?'</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 随机生成 20 个周期的输入输出对</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        <span class="comment"># 生成一个 8 位随机数作为输入</span></span><br><span class="line">        rand_value = b8(random.randint(<span class="number">0</span>, <span class="number">0xff</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将输入值和上一个周期的期望输出添加到测试向量表</span></span><br><span class="line">        test_vector_table.append([rand_value, last_result])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算当前输入值的期望输出（输入值 +1，确保为 8 位）</span></span><br><span class="line">        last_result = b8(rand_value + <span class="number">1</span>, trunc_int=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行测试向量模拟</span></span><br><span class="line">    run_test_vector_sim(RegIncr(), test_vector_table, cmdline_opts)</span><br></pre></td></tr></table></figure></div>

<p>代码解析:</p>
<ol>
<li>导入 random 模块：使用 Python 的 random 模块生成随机输入值。</li>
<li>定义测试向量表：</li>
</ol>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_vector_table = [(<span class="string">'in_'</span>, <span class="string">'out*'</span>)]</span><br></pre></td></tr></table></figure></div>

<p>初始化测试向量表，首行为表头，<code>in_</code> 为输入端口，<code>out*</code> 为输出端口。</p>
<ol start="3">
<li>设置期望输出的初始值：</li>
</ol>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">last_result = <span class="string">'?'</span></span><br></pre></td></tr></table></figure></div>

<p><code>last_result</code> 初始值为 <code>'?'</code>，表示在第一个周期不关心输出值。</p>
<ol start="4">
<li>生成随机测试向量：</li>
</ol>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    rand_value = b8(random.randint(<span class="number">0</span>, <span class="number">0xff</span>))</span><br><span class="line">    test_vector_table.append([rand_value, last_result])</span><br><span class="line">    last_result = b8(rand_value + <span class="number">1</span>, trunc_int=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></div>

<ul>
<li>循环生成 20 个测试向量，每次随机生成一个 8 位输入值 <code>rand_value</code>。</li>
<li><code>rand_value</code> 和 <code>last_result</code> 被添加到测试向量表中。</li>
<li>更新 <code>last_result</code> 为当前输入值加 1 的结果，用于下一个周期的期望输出。<code>trunc_int=True</code> 确保溢出时截断到 8 位。</li>
</ul>
<ol start="5">
<li>运行测试：</li>
</ol>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run_test_vector_sim(RegIncr(), test_vector_table, cmdline_opts)</span><br></pre></td></tr></table></figure></div>

<p>通过 <code>run_test_vector_sim</code> 函数运行测试向量模拟，以验证模型对随机输入的处理是否正确。</p>
<p>我们还可以运行随机测试并启用行跟踪。在终端中执行以下命令运行随机测试用例，并启用行跟踪（<code>-s</code> 选项显示输出）：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ${TUTROOT}/build</span><br><span class="line">pytest ../tut3_pymtl/regincr/test/RegIncr_extra_test.py -k random -s</span><br></pre></td></tr></table></figure></div>

<p>此命令将运行 <code>test_random</code> 测试函数，并打印出行跟踪信息，有助于观察每个周期的输入输出关系。<code>-k random</code> 参数确保仅运行包含<code>random</code>名称的测试。</p>
<p><strong>注意：在设计随机测试时，应考虑模型的延迟，确保期望输出与正确的周期对应。对于复杂模型，可以增加随机测试的周期数以增强测试覆盖率。</strong></p>
<h3 id="4-7-两级寄存递增器的设计与测试"><a href="#4-7-两级寄存递增器的设计与测试" class="headerlink" title="4.7 两级寄存递增器的设计与测试"></a>4.7 两级寄存递增器的设计与测试</h3><p>本节详细介绍了如何通过模块化和层次化设计思想，将简单的单级寄存递增器模型（RegIncr）组合成一个两级寄存递增器（RegIncr2stage）。</p>
<p>下图展示了两级寄存递增器的硬件结构，其中：</p>
<ul>
<li>输入端口 in 接收 8 位数据。</li>
<li>两个 RegIncr 模块串联，分别完成递增操作。</li>
<li>输出端口 out 传递最终结果。</li>
</ul>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24112501.png" alt="24112501"></p>
<p>以下为两级寄存递增器的 PyMTL3 实现。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> .RegIncr <span class="keyword">import</span> RegIncr</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RegIncr2stage</span>( <span class="title class_ inherited__">Component</span> ):</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构造函数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">construct</span>(<span class="params"> s </span>):</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 接口定义：输入和输出均为 8 位宽</span></span><br><span class="line">        s.in_ = InPort(<span class="number">8</span>)</span><br><span class="line">        s.out = OutPort(<span class="number">8</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 第一级：实例化第一个单级寄存递增器</span></span><br><span class="line">        s.reg_incr_0 = RegIncr()</span><br><span class="line">        connect( s.in_, s.reg_incr_0.in_ )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 第二级：实例化第二个单级寄存递增器</span></span><br><span class="line">        s.reg_incr_1 = RegIncr()</span><br><span class="line">        s.reg_incr_0.out //= s.reg_incr_1.in_  <span class="comment"># 使用//= 连接信号</span></span><br><span class="line">        s.reg_incr_1.out //= s.out</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">line_trace</span>(<span class="params"> s </span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"{} ({}|{}) {}"</span>.<span class="built_in">format</span>(</span><br><span class="line">        s.in_,</span><br><span class="line">        s.reg_incr_0.line_trace(),  <span class="comment"># 第一阶段的线性跟踪</span></span><br><span class="line">        s.reg_incr_1.line_trace(),  <span class="comment"># 第二阶段的线性跟踪</span></span><br><span class="line">        s.out</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></div>

<p>代码解析</p>
<p>接口定义：</p>
<ul>
<li><code>s.in_</code> 是输入端口，接收 8 位宽的数据。</li>
<li><code>s.out</code> 是输出端口，输出最终的处理结果。</li>
</ul>
<p>模块实例化：</p>
<ul>
<li>分别实例化了两个单级寄存递增器（<code>RegIncr</code>），分别完成第一阶段和第二阶段的递增操作。</li>
</ul>
<p>端口连接：</p>
<ul>
<li>使用 connect 方法和 <code>//=</code> 操作符连接输入、输出和子模块接口。</li>
</ul>
<p>层次化设计：</p>
<ul>
<li>line_trace 方法结合子模块的 line_trace 输出，提供了两阶段递增器内部状态的完整视图。</li>
</ul>
<p>测试脚本通过多个测试用例验证了两级寄存递增器的功能，包括：</p>
<ol>
<li>小值测试（Small Test）：测试小范围数据的递增功能。</li>
<li>大值测试（Large Test）：验证较大范围数据的处理情况。</li>
<li>溢出测试（Overflow Test）：测试数据溢出的正确性。</li>
<li>随机测试（Random Test）：随机生成数据进行验证，覆盖更广的数据范围。</li>
</ol>
<p>以下为部分测试脚本实现：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pymtl3.stdlib.test_utils <span class="keyword">import</span> run_test_vector_sim</span><br><span class="line"><span class="keyword">from</span> ..RegIncr2stage <span class="keyword">import</span> RegIncr2stage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 小值测试</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_small</span>(<span class="params"> cmdline_opts </span>):</span><br><span class="line">    run_test_vector_sim( RegIncr2stage(), [</span><br><span class="line">        (<span class="string">'in_ out*'</span>),</span><br><span class="line">        [ <span class="number">0x00</span>,<span class="string">'?'</span> ],  <span class="comment"># 第一周期：输出未知</span></span><br><span class="line">        [ <span class="number">0x03</span>,<span class="string">'?'</span> ],  <span class="comment"># 第二周期：输出未知</span></span><br><span class="line">        [ <span class="number">0x06</span>, <span class="number">0x02</span> ],  <span class="comment"># 第三周期：输出0x02（0x00+2）</span></span><br><span class="line">        [ <span class="number">0x00</span>, <span class="number">0x05</span> ],  <span class="comment"># 第四周期：输出0x05（0x03+2）</span></span><br><span class="line">        [ <span class="number">0x00</span>, <span class="number">0x08</span> ],  <span class="comment"># 第五周期：输出0x08（0x06+2）</span></span><br><span class="line">    ], cmdline_opts )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机测试</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_random</span>(<span class="params"> cmdline_opts </span>):</span><br><span class="line">    test_vector_table = [(<span class="string">'in_'</span>, <span class="string">'out*'</span>)]</span><br><span class="line">    last_result_0 = <span class="string">'?'</span></span><br><span class="line">    last_result_1 = <span class="string">'?'</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        rand_value = b8( random.randint(<span class="number">0</span>, <span class="number">0xff</span>) )</span><br><span class="line">        test_vector_table.append([rand_value, last_result_1])</span><br><span class="line">        last_result_1 = last_result_0</span><br><span class="line">        last_result_0 = b8(rand_value + <span class="number">2</span>, trunc_int=<span class="literal">True</span>)</span><br><span class="line">    run_test_vector_sim( RegIncr2stage(), test_vector_table, cmdline_opts )</span><br></pre></td></tr></table></figure></div>

<p>逻辑说明:</p>
<p>延迟处理：</p>
<ul>
<li>由于两级寄存递增器的两周期延迟，前两周期的输出为未知值（<code>?</code>）。</li>
<li>测试用例在第三周期开始断言输出值是否正确。</li>
</ul>
<p>随机测试：</p>
<ul>
<li>随机生成 20 组输入数据，通过计算参考输出（<code>+2</code>），验证递增器的功能正确性。</li>
<li>延迟处理同样适用于随机测试，注意保持参考输出与实际行为的一致性。</li>
</ul>
<p>输出结果为：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(pymtl3_env) (usr) albert@alberts-fedora:~/CSC/cpt4$ pytest RegIncr2stage_test.py </span><br><span class="line">======================================== <span class="built_in">test</span> session starts =========================================</span><br><span class="line">platform linux -- Python 3.8.20, pytest-7.2.0, pluggy-1.5.0</span><br><span class="line">rootdir: /home/albert/CSC/cpt4</span><br><span class="line">plugins: hypothesis-6.113.0, pymtl3-3.1.16</span><br><span class="line">collected 2 items                                                                                    </span><br><span class="line"></span><br><span class="line">RegIncr2stage_test.py ..                                                                       [100%]</span><br><span class="line"></span><br><span class="line">========================================= 2 passed <span class="keyword">in</span> 0.73s ==========================================</span><br></pre></td></tr></table></figure></div>

<p>接下来可以进行运行测试与结果分析。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行所有测试用例</span></span><br><span class="line">% <span class="built_in">cd</span> <span class="variable">${TUTROOT}</span>/build</span><br><span class="line">% pytest ../tut3_pymtl/regincr/test/RegIncr2stage_test.py -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行特定测试用例</span></span><br><span class="line">% pytest ../tut3_pymtl/regincr/test/RegIncr2stage_test.py -k test_small</span><br></pre></td></tr></table></figure></div>

<p>运行以下命令生成线性跟踪信息：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">% pytest ../tut3_pymtl/regincr/test/RegIncr2stage_test.py -k test_small -s</span><br></pre></td></tr></table></figure></div>

<p>图 20 展示了 test_small 测试的线性跟踪结果，其中：</p>
<ul>
<li>每一列对应模型中不同模块的状态。</li>
<li>数据从 <code>in</code> 输入，经过 <code>reg_incr_0</code> 和 <code>reg_incr_1</code> 两阶段处理，最终输出到 <code>out</code>。</li>
<li>通过观察高亮标注的 <code>0x03</code>，可以清晰地看到数据如何逐周期传递并递增。</li>
</ul>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24112502.png" alt="24112502"></p>
<p>运行的输出结果为：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(pymtl3_env) (usr) albert@alberts-fedora:~/CSC/cpt4$ pytest RegIncr2stage_test.py -k test_small -s</span><br><span class="line">======================================================== <span class="built_in">test</span> session starts =========================================================</span><br><span class="line">platform linux -- Python 3.8.20, pytest-7.2.0, pluggy-1.5.0</span><br><span class="line">rootdir: /home/albert/CSC/cpt4</span><br><span class="line">plugins: hypothesis-6.113.0, pymtl3-3.1.16</span><br><span class="line">collected 2 items / 1 deselected / 1 selected                                                                                        </span><br><span class="line"></span><br><span class="line">RegIncr2stage_test.py </span><br><span class="line">  1r 00 (00 (00) 01|01 (00) 01) 01</span><br><span class="line">  2r 00 (00 (00) 01|01 (00) 01) 01</span><br><span class="line">  3: 00 (00 (00) 01|01 (00) 01) 01</span><br><span class="line">  4: 03 (03 (00) 01|01 (01) 02) 02</span><br><span class="line">  5: 06 (06 (03) 04|04 (01) 02) 02</span><br><span class="line">  6: 00 (00 (06) 07|07 (04) 05) 05</span><br><span class="line">  7: 00 (00 (00) 01|01 (07) 08) 08</span><br><span class="line">  8: 00 (00 (00) 01|01 (01) 02) 02</span><br><span class="line">  9: 00 (00 (00) 01|01 (01) 02) 02</span><br><span class="line"> 10: 00 (00 (00) 01|01 (01) 02) 02</span><br><span class="line">.</span><br><span class="line"></span><br><span class="line">================================================== 1 passed, 1 deselected <span class="keyword">in</span> 0.74s ===================================================</span><br></pre></td></tr></table></figure></div>

<p>使用以下命令生成 VCD 波形文件：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">% pytest ../tut3_pymtl/regincr/test/RegIncr2stage_test.py --dump-vcd</span><br><span class="line">% <span class="built_in">ls</span> *.vcd</span><br></pre></td></tr></table></figure></div>

<p>以下是生成的vcd波形文件，分别为small与random：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24112503.png" alt="24112503"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24112504.png" alt="24112504"></p>
<h3 id="4-8-使用“静态”展开进行组件参数化"><a href="#4-8-使用“静态”展开进行组件参数化" class="headerlink" title="4.8 使用“静态”展开进行组件参数化"></a>4.8 使用“静态”展开进行组件参数化</h3><p>在硬件设计中，参数化组件能够显著提高模块的复用性，并支持灵活的设计空间探索。PyMTL3 提供了动态硬件生成工具，结合 Python 的动态特性，允许通过参数化实现组件的“静态”展开。参数化组件可以通过构造函数传递参数来决定组件的接口、行为以及子组件的结构组合。</p>
<p>需要注意的是：</p>
<ul>
<li>PyMTL3 的静态展开（Static Elaboration）发生在模拟器或测试脚本的运行时，通过 Python 的动态代码生成硬件结构。</li>
<li>这种展开过程与传统硬件描述语言（如 Verilog 或 VHDL）的静态展开类似，只不过 PyMTL3 是在“运行时”完成展开。</li>
<li>参数化组件的不同配置需要独立验证，这通常要求更加复杂的测试策略以覆盖所有可能的参数组合。</li>
</ul>
<p>下面是一个支持位宽（nbits）和递增量（amount）参数化的组合逻辑递增器。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Incrementer</span>( <span class="title class_ inherited__">Component</span> ):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">construct</span>(<span class="params"> s, nbits=<span class="number">1</span>, amount=<span class="number">1</span> </span>):  <span class="comment"># 参数 nbits 和 amount</span></span><br><span class="line">        <span class="comment"># 接口</span></span><br><span class="line">        s.in_ = InPort( nbits )</span><br><span class="line">        s.out = OutPort( nbits )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 参数化递增逻辑</span></span><br><span class="line"><span class="meta">        @update</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">comb_logic</span>():</span><br><span class="line">            s.out @= s.in_ + amount</span><br></pre></td></tr></table></figure></div>

<ul>
<li>端口宽度通过 <code>nbits</code> 参数控制，适用于不同数据宽度的输入和输出信号。</li>
<li>递增量由 <code>amount</code> 参数决定，使递增器能够适配不同加法需求。</li>
</ul>
<p>下面是一个支持寄存器级数参数化的多级寄存递增器（RegIncrNstage）。通过参数 <code>nstages</code>，用户可以灵活指定寄存递增器的级数。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> .RegIncr <span class="keyword">import</span> RegIncr</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RegIncrNstage</span>( <span class="title class_ inherited__">Component</span> ):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">construct</span>(<span class="params"> s, nstages=<span class="number">2</span> </span>):  <span class="comment"># 参数 nstages 指定寄存递增器的级数</span></span><br><span class="line">        <span class="comment"># 接口定义</span></span><br><span class="line">        s.in_ = InPort(<span class="number">8</span>)</span><br><span class="line">        s.out = OutPort(<span class="number">8</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 实例化多级寄存递增器</span></span><br><span class="line">        s.reg_incrs = [ RegIncr() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(nstages) ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 输入连接到第一个寄存递增器</span></span><br><span class="line">        s.in_ //= s.reg_incrs[<span class="number">0</span>].in_</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 级联连接</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nstages - <span class="number">1</span>):</span><br><span class="line">            s.reg_incrs[i].out //= s.reg_incrs[i+<span class="number">1</span>].in_</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 输出连接到最后一个寄存递增器</span></span><br><span class="line">        s.reg_incrs[-<span class="number">1</span>].out //= s.out</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 线性跟踪</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">line_trace</span>(<span class="params"> s </span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"<span class="subst">{s.in_}</span> "</span> \</span><br><span class="line">               <span class="string">f"(<span class="subst">{<span class="string">'|'</span>.join([ <span class="built_in">str</span>(x.out) <span class="keyword">for</span> x <span class="keyword">in</span> s.reg_incrs ])}</span>) "</span> \</span><br><span class="line">               <span class="string">f"<span class="subst">{s.out}</span>"</span></span><br></pre></td></tr></table></figure></div>


<p>参数化组件的不同配置需要动态生成测试用例和测试向量，以覆盖所有参数组合。</p>
<p>对于参数化的寄存递增器，其参考输出与级数（nstages）相关，需要动态生成测试向量表。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">mk_test_vector_table</span>(<span class="params"> nstages, inputs </span>):</span><br><span class="line">    <span class="comment"># 补充零值以模拟延迟</span></span><br><span class="line">    inputs.extend( [<span class="number">0</span>]*nstages )</span><br><span class="line">    </span><br><span class="line">    test_vector_table = [ (<span class="string">'in_ out*'</span>) ]</span><br><span class="line">    last_results = collections.deque( [<span class="string">'?'</span>]*nstages )  <span class="comment"># 初始化延迟队列</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> input_ <span class="keyword">in</span> inputs:</span><br><span class="line">        test_vector_table.append( [ input_, last_results.popleft() ] )</span><br><span class="line">        last_results.append( b8( input_ + nstages, trunc_int=<span class="literal">True</span> ) )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> test_vector_table</span><br></pre></td></tr></table></figure></div>

<p>解析：</p>
<ol>
<li>延迟模拟：</li>
</ol>
<ul>
<li>使用 <code>collections.deque</code> 模拟多级寄存递增器的延迟。</li>
<li>输入向量后补零，确保输出参考值正确。</li>
</ul>
<ol start="2">
<li>位截断：</li>
</ol>
<ul>
<li>使用 <code>trunc_int=True</code> 确保计算结果符合位宽限制。</li>
</ul>
<p>通过 <code>pytest.mark.parametrize</code>，可以为参数化组件生成测试用例。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">test_case_table = mk_test_case_table([</span><br><span class="line">    ( <span class="string">"nstages inputs "</span>),</span><br><span class="line">    [ <span class="string">"2stage_small"</span>, <span class="number">2</span>, [ <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x06</span> ] ],</span><br><span class="line">    [ <span class="string">"2stage_large"</span>, <span class="number">2</span>, [ <span class="number">0xa0</span>, <span class="number">0xb3</span>, <span class="number">0xc6</span> ] ],</span><br><span class="line">    [ <span class="string">"3stage_small"</span>, <span class="number">3</span>, [ <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x06</span> ] ],</span><br><span class="line">    [ <span class="string">"3stage_large"</span>, <span class="number">3</span>, [ <span class="number">0xa0</span>, <span class="number">0xb3</span>, <span class="number">0xc6</span> ] ],</span><br><span class="line">])</span><br><span class="line"><span class="meta">@pytest.mark.parametrize(<span class="params"> **test_case_table </span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params"> test_params, cmdline_opts </span>):</span><br><span class="line">    nstages = test_params.nstages</span><br><span class="line">    inputs = test_params.inputs</span><br><span class="line">    run_test_vector_sim( RegIncrNstage( nstages ),</span><br><span class="line">                         mk_test_vector_table( nstages, inputs ), cmdline_opts )</span><br></pre></td></tr></table></figure></div>

<ul>
<li>每一行对应一个参数化测试，列表示不同的参数。</li>
<li><code>pytest.mark.parametrize</code> 自动生成并运行对应的测试用例。</li>
</ul>
<p>使用随机生成的输入向量对多级寄存递增器进行测试。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@pytest.mark.parametrize(<span class="params"> <span class="string">"n"</span>, [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span> ] </span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_random</span>(<span class="params"> n, cmdline_opts </span>):</span><br><span class="line">    run_test_vector_sim( RegIncrNstage( nstages=n ),</span><br><span class="line">                         mk_test_vector_table( n, sample(<span class="built_in">range</span>(<span class="number">0xff</span>),<span class="number">20</span>) ), cmdline_opts )</span><br></pre></td></tr></table></figure></div>

<ul>
<li>使用 <code>sample(range(0xff), 20)</code> 生成 20 个随机输入值。</li>
</ul>
<p>运行所有测试用例：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">% <span class="built_in">cd</span> <span class="variable">${TUTROOT}</span>/build</span><br><span class="line">% pytest ../tut3_pymtl/regincr/test/RegIncrNstage_test.py -v</span><br></pre></td></tr></table></figure></div>

<p>运行指定测试用例：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">% pytest ../tut3_pymtl/regincr/test/RegIncrNstage_test.py -k 3stage -sv</span><br></pre></td></tr></table></figure></div>

<p>生成波形文件：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">% pytest ../tut3_pymtl/regincr/test/RegIncrNstage_test.py --dump-vcd</span><br><span class="line">% <span class="built_in">ls</span> *.vcd</span><br></pre></td></tr></table></figure></div>

<ul>
<li>测试通过显示 <code>PASSED</code>，若失败会显示 <code>FAILED</code>。</li>
<li>参数化测试生成的测试用例以方括号标记参数组合（如 <code>test[2stage_small]</code>）。</li>
</ul>
<h3 id="4-9-打包模型集合"><a href="#4-9-打包模型集合" class="headerlink" title="4.9 打包模型集合"></a>4.9 打包模型集合</h3><p>在硬件设计中，尤其是使用 PyMTL3 框架时，将相关模型组织到单独的子目录中可以显著提升项目的模块化程度。通过打包（Packaging），可以使这些子目录成为标准的 Python 包，并通过 <code>import</code> 命令方便地在其他子项目中复用这些模型。本节详细介绍了如何配置打包、使用模型集合，以及如何正确管理包路径。</p>
<ol>
<li>什么是打包？</li>
</ol>
<ul>
<li>打包是将一个子目录（即子项目）转换为标准 Python 包的过程。一个打包的子项目可以通过 <code>import</code> 命令访问其内部的模型、函数或类。</li>
<li>打包的核心是创建一个 Python 包配置脚本，命名为 <code>__init__.py</code>，并将其放置在子项目的根目录中。</li>
</ul>
<ol start="2">
<li>子项目目录结构</li>
</ol>
<ul>
<li>子项目通常由一组相关模型组成，位于一个单独的子目录中。</li>
<li>如果子项目中存在嵌套的子目录，每个子目录都需要包含一个 <code>__init__.py</code> 文件，即使该文件为空。</li>
</ul>
<ol start="3">
<li><code>__init__.py</code> 的作用</li>
</ol>
<ul>
<li><code>__init__.py</code> 脚本的主要功能是导入子项目中的模型、函数或类，从而创建包命名空间。</li>
</ul>
<p>下面展示了 <code>regincr</code> 包的配置脚本 <code>__init__.py</code> 的内容。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#=========================================================================</span></span><br><span class="line"><span class="comment"># regincr</span></span><br><span class="line"><span class="comment">#=========================================================================</span></span><br><span class="line"><span class="keyword">from</span> .RegIncr <span class="keyword">import</span> RegIncr  <span class="comment"># 导入单级寄存递增器模型</span></span><br><span class="line"><span class="keyword">from</span> .RegIncr2stage <span class="keyword">import</span> RegIncr2stage  <span class="comment"># 导入两级寄存递增器模型</span></span><br><span class="line"><span class="keyword">from</span> .RegIncrNstage <span class="keyword">import</span> RegIncrNstage  <span class="comment"># 导入多级寄存递增器模型</span></span><br></pre></td></tr></table></figure></div>

<p>解析：</p>
<ol>
<li>导入模型：</li>
</ol>
<ul>
<li>将 <code>regincr</code> 子项目中的所有模型导入包命名空间。</li>
<li>使用 <code>from .</code> 表示从当前目录（即 <code>regincr</code> 子目录）导入模块。</li>
</ul>
<ol start="2">
<li>灵活扩展：</li>
</ol>
<ul>
<li>除了模型，还可以将其他功能，例如辅助函数或工具类，导入包命名空间，供外部使用。</li>
</ul>
<p>在项目根目录（TUTROOT）中，可以直接导入打包后的 <code>regincr</code> 子项目，并对其中的模型进行使用和仿真。</p>
<p>下面展示了如何从项目根目录导入包，并对模型进行简单仿真。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">% <span class="built_in">cd</span> <span class="variable">${TUTROOT}</span>  <span class="comment"># 切换到项目根目录</span></span><br><span class="line">% python          <span class="comment"># 启动 Python 解释器</span></span><br></pre></td></tr></table></figure></div>

<p>我们之前建议使用conda在虚拟环境中运行，如果你遵守了，操作流程也是类似的。</p>
<p>在 Python 交互环境中，运行以下命令：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from pymtl3 import *                             <span class="comment"># 导入 PyMTL3 框架</span></span><br><span class="line">&gt;&gt;&gt; from tut3_pymtl.regincr import RegIncr           <span class="comment"># 从 regincr 包中导入 RegIncr 模型</span></span><br><span class="line">&gt;&gt;&gt; model = RegIncr()                                <span class="comment"># 实例化模型</span></span><br><span class="line">&gt;&gt;&gt; model.apply( DefaultPassGroup() )                <span class="comment"># 应用默认 Pass 组</span></span><br><span class="line">&gt;&gt;&gt; model.sim_reset()                                <span class="comment"># 重置仿真</span></span><br><span class="line">&gt;&gt;&gt; model.in_ @= 0x24                                <span class="comment"># 设置输入</span></span><br><span class="line">&gt;&gt;&gt; model.sim_tick()                                 <span class="comment"># 执行一个时钟周期</span></span><br><span class="line">&gt;&gt;&gt; model.out                                        <span class="comment"># 检查输出</span></span><br><span class="line">Bits8(0x25)                                          <span class="comment"># 输出正确，递增 1</span></span><br></pre></td></tr></table></figure></div>

<p>解析：</p>
<ul>
<li><p>使用 <code>from tut3_pymtl.regincr import RegIncr</code> 导入模型。</p>
</li>
<li><p>使用 PyMTL3 的 API 对模型进行仿真，包括初始化、设置输入值、执行时钟周期操作，以及读取输出值。</p>
</li>
</ul>
<p>四、从构建目录中导入包</p>
<p>如果切换到构建目录（build），直接导入 <code>tut3_pymtl.regincr</code> 包会报错。因为 Python 默认的搜索路径不包含 <code>tut3_pymtl</code> 包所在的项目根目录。</p>
<p>下面展示了如何通过设置环境变量 <code>PYTHONPATH</code> 解决这一问题。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">% <span class="built_in">cd</span> <span class="variable">${TUTROOT}</span>/build                     <span class="comment"># 切换到构建目录</span></span><br><span class="line">% <span class="built_in">env</span> PYTHONPATH=<span class="string">".."</span> python              <span class="comment"># 设置 PYTHONPATH 为项目根目录</span></span><br></pre></td></tr></table></figure></div>

<p>在 Python 交互环境中，运行以下命令：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from tut3_pymtl.regincr import RegIncr           <span class="comment"># 导入 RegIncr 模型</span></span><br><span class="line">&gt;&gt;&gt; model = RegIncr()                                <span class="comment"># 实例化模型</span></span><br><span class="line">&gt;&gt;&gt; model.elaborate()                                <span class="comment"># 展开模型结构</span></span><br><span class="line">&gt;&gt;&gt; [ x.get_field_name() <span class="keyword">for</span> x <span class="keyword">in</span> model.get_input_value_ports() ]  <span class="comment"># 获取输入端口名称</span></span><br><span class="line">[<span class="string">'clk'</span>, <span class="string">'in_'</span>, <span class="string">'reset'</span>]</span><br><span class="line">&gt;&gt;&gt; [ x.get_field_name() <span class="keyword">for</span> x <span class="keyword">in</span> model.get_wires() ]             <span class="comment"># 获取内部连线名称</span></span><br><span class="line">[<span class="string">'reg_out'</span>]</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p>使用 <code>env PYTHONPATH=".."</code> 将项目根目录添加到 Python 包搜索路径。</p>
</li>
<li><p>调用 <code>model.elaborate()</code> 方法展开模型，生成完整的硬件结构。</p>
</li>
<li><p>使用 PyMTL3 提供的接口检查方法，例如 <code>get_input_value_ports()</code> 和 <code>get_wires()</code>，可以获取模型的输入输出端口及内部连线信息。</p>
</li>
</ul>
<p>PyMTL3 框架提供了一系列强大的 API，用于检查已展开（elaborated）模型的结构和组件。这些工具对于调试复杂模型和参数化模型尤为有用。</p>
<ol>
<li>获取端口信息：</li>
</ol>
<ul>
<li><code>get_input_value_ports()</code>：返回模型的输入端口列表。</li>
<li><code>get_output_value_ports()</code>：返回模型的输出端口列表。</li>
</ul>
<ol start="2">
<li>获取内部连线：</li>
</ol>
<ul>
<li><code>get_wires()</code>：返回模型内部的连线。</li>
</ul>
<ol start="3">
<li>获取子组件：</li>
</ol>
<ul>
<li><code>get_child_components()</code>：返回模型的子组件列表。</li>
</ul>
<ol start="4">
<li>获取并发块：</li>
</ol>
<ul>
<li><code>get_update_blocks()</code>：返回模型的并发块。</li>
</ul>
<p>示例：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; model.get_input_value_ports()        <span class="comment"># 检查输入端口</span></span><br><span class="line">&gt;&gt;&gt; model.get_child_components()         <span class="comment"># 检查子组件</span></span><br></pre></td></tr></table></figure></div>


<h2 id="第05章-排序单元-Sort-Unit"><a href="#第05章-排序单元-Sort-Unit" class="headerlink" title="第05章 排序单元(Sort Unit)"></a>第05章 排序单元(Sort Unit)</h2><h3 id="5-1-排序单元的-FL-模型"><a href="#5-1-排序单元的-FL-模型" class="headerlink" title="5.1 排序单元的 FL 模型"></a>5.1 排序单元的 FL 模型</h3><p><strong>功能级（Functional-Level，FL）模型专注于实现目标硬件的功能行为，而不关注具体的硬件时序。FL 模型通常是硬件设计的第一步，它可以快速实现功能验证，同时为后续的周期级（Cycle-Level，CL）和寄存器传输级（Register-Transfer-Level，RTL）模型设计打下基础。</strong></p>
<p><strong>排序单元（Sort Unit）</strong>的功能是对四个输入值进行排序，使输出端口按从小到大的顺序排列。排序单元具有以下接口：</p>
<p>输入端口：</p>
<ul>
<li><code>in_val</code>：标志输入值是否有效。</li>
<li><code>in_[0:3]</code>：四个待排序的输入值。</li>
</ul>
<p>输出端口：</p>
<ul>
<li><code>out_val</code>：标志输出值是否有效。</li>
<li><code>out[0:3]</code>：按升序排列的输出值。</li>
</ul>
<p>下图使用 “cloud diagram” 对排序单元进行了抽象表示，重点突出其功能逻辑，而忽略了具体的实现细节:</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24112001.png" alt="24112001"></p>
<p>FL 模型的设计主要关注以下几点：</p>
<ol>
<li>功能实现：使用简单的排序函数实现输入值的排序逻辑。</li>
<li>有效性标志：通过 <code>in_val</code> 和 <code>out_val</code> 标志输入和输出值的有效性。</li>
<li>行跟踪（Line Trace）：提供易于阅读的输入输出状态显示。</li>
<li>默认信号重置：依赖 PyMTL3 框架的默认信号初始化功能。</li>
</ol>
<p>以下代码展示了排序单元 FL 模型的实现，<em>核心功能是对输入端口的四个值进行排序，并通过输出端口返回结果</em>。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排序功能实现</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sort_fl</span>(<span class="params">arr</span>):</span><br><span class="line">    <span class="string">"""排序函数，接收一个数组并返回排序后的结果。"""</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sorted</span>(arr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排序单元 FL 模型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SortUnitFL</span>(<span class="title class_ inherited__">Component</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造函数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">construct</span>(<span class="params">s, nbits=<span class="number">8</span></span>):</span><br><span class="line">        <span class="comment"># 定义输入端口</span></span><br><span class="line">        s.in_val = InPort()  <span class="comment"># 输入有效性标志</span></span><br><span class="line">        s.in_ = [InPort(nbits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]  <span class="comment"># 四个输入端口</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 定义输出端口</span></span><br><span class="line">        s.out_val = OutPort()  <span class="comment"># 输出有效性标志</span></span><br><span class="line">        s.out = [OutPort(nbits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]  <span class="comment"># 四个输出端口</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 核心排序逻辑（update_ff 块）</span></span><br><span class="line"><span class="meta">        @update_ff</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">block</span>():</span><br><span class="line">            <span class="comment"># 将输入有效性标志传递到输出</span></span><br><span class="line">            s.out_val &lt;&lt;= s.in_val</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 对输入端口值排序，并赋值到输出端口</span></span><br><span class="line">            <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(sort_fl(s.in_)):</span><br><span class="line">                s.out[i] &lt;&lt;= v</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 行跟踪（显示输入输出状态）</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">line_trace</span>(<span class="params">s</span>):</span><br><span class="line">        <span class="comment"># 输入状态字符串</span></span><br><span class="line">        in_str = <span class="string">'{'</span> + <span class="string">','</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, s.in_)) + <span class="string">'}'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> s.in_val:</span><br><span class="line">            in_str = <span class="string">' '</span> * <span class="built_in">len</span>(in_str)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 输出状态字符串</span></span><br><span class="line">        out_str = <span class="string">'{'</span> + <span class="string">','</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, s.out)) + <span class="string">'}'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> s.out_val:</span><br><span class="line">            out_str = <span class="string">' '</span> * <span class="built_in">len</span>(out_str)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 返回格式化的输入输出状态</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"<span class="subst">{in_str}</span>|<span class="subst">{out_str}</span>"</span></span><br></pre></td></tr></table></figure></div>

<p>代码解释：</p>
<ol>
<li>排序功能实现（<code>sort_fl</code> 函数）：</li>
</ol>
<ul>
<li>使用 Python 的内置 <code>sorted</code> 函数对数组进行排序。</li>
<li>该函数对 <code>in_</code> 输入端口的四个值排序后，将结果传递给输出端口 <code>out</code>。</li>
</ul>
<ol start="2">
<li>输入输出端口定义：</li>
</ol>
<ul>
<li><code>InPort</code> 和 <code>OutPort</code> 用于定义输入和输出接口，支持参数化位宽（默认为 8 位）。</li>
<li>输入端口包括 <code>in_val</code>（输入有效性标志）和 <code>in_[0:3]</code>（四个待排序的值）。</li>
<li>输出端口包括 <code>out_val</code>（输出有效性标志）和 <code>out[0:3]</code>（排序后的值）。</li>
</ul>
<ol start="3">
<li>核心排序逻辑：</li>
</ol>
<ul>
<li>使用 <code>@update_ff</code> 定义逻辑块，确保信号值在时钟上升沿后更新。</li>
<li>通过非阻塞赋值（<code>&lt;&lt;=</code>）将排序后的结果赋值到输出端口。</li>
<li>输入有效性标志 <code>in_val</code> 被直接传递到输出有效性标志 <code>out_val</code>。</li>
</ul>
<ol start="4">
<li>行跟踪（Line Trace）：</li>
</ol>
<ul>
<li>提供 <code>line_trace</code> 方法，用于在模拟过程中格式化显示输入输出状态。</li>
<li>当输入或输出无效时，用空格代替显示，使得行跟踪信息更加直观。</li>
<li>例如：{8,3,5,1}|{1,3,5,8} 表示输入值为 {8,3,5,1}，排序后输出 {1,3,5,8}。</li>
</ul>
<ol start="5">
<li>默认信号重置：</li>
</ol>
<ul>
<li>PyMTL3 框架默认将信号初始化为 0，简化了 FL 模型的设计。</li>
<li>这种简化在 CL 模型中也适用，但在 RTL 模型中需要显式实现状态重置。</li>
</ul>
<p>接下来可以进行排序单元的测试。排序单元测试包括四个定向测试用例和一个随机测试用例。这些测试验证了 SortUnitFL 的功能正确性：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pymtl3.stdlib.test_utils <span class="keyword">import</span> run_test_vector_sim</span><br><span class="line"><span class="keyword">from</span> SortUnitFL <span class="keyword">import</span> SortUnitFL</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基本测试</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_basic</span>(<span class="params">cmdline_opts</span>):</span><br><span class="line">    run_test_vector_sim(SortUnitFL(), [</span><br><span class="line">        <span class="comment"># 定义测试向量表：第一行为端口名称，后续行为测试数据</span></span><br><span class="line">        (<span class="string">'in_val in_[0] in_[1] in_[2] in_[3] out_val out[0] out[1] out[2] out[3]*'</span>),</span><br><span class="line">        <span class="comment"># 复位周期：无输入，无输出</span></span><br><span class="line">        [ <span class="number">0</span>,      <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>       ],</span><br><span class="line">        <span class="comment"># 第一个输入周期：输入有效，等待排序结果</span></span><br><span class="line">        [ <span class="number">1</span>,      <span class="number">8</span>,    <span class="number">3</span>,    <span class="number">5</span>,    <span class="number">1</span>,    <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>       ],</span><br><span class="line">        <span class="comment"># 输出周期：输出排序结果</span></span><br><span class="line">        [ <span class="number">0</span>,      <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">3</span>,     <span class="number">5</span>,     <span class="number">8</span>       ],</span><br><span class="line">    ], cmdline_opts)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机测试</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_random</span>(<span class="params">cmdline_opts</span>):</span><br><span class="line">    <span class="keyword">import</span> random</span><br><span class="line">    <span class="comment"># 定义测试向量表</span></span><br><span class="line">    test_vector_table = [</span><br><span class="line">        (<span class="string">'in_val in_[0] in_[1] in_[2] in_[3] out_val out[0] out[1] out[2] out[3]*'</span>)</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># 添加复位周期</span></span><br><span class="line">    test_vector_table.append([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成随机输入测试</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        <span class="comment"># 随机生成4个输入值</span></span><br><span class="line">        rand_inputs = [random.randint(<span class="number">0</span>, <span class="number">255</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">        sorted_outputs = <span class="built_in">sorted</span>(rand_inputs)  <span class="comment"># 对随机输入进行排序</span></span><br><span class="line">        <span class="comment"># 输入有效周期</span></span><br><span class="line">        test_vector_table.append([<span class="number">1</span>] + rand_inputs + [<span class="number">0</span>] + [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">        <span class="comment"># 输出有效周期</span></span><br><span class="line">        test_vector_table.append([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>] + sorted_outputs)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 运行测试</span></span><br><span class="line">    run_test_vector_sim(SortUnitFL(), test_vector_table, cmdline_opts)</span><br></pre></td></tr></table></figure></div>

<ul>
<li>运行所有测试：</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="built_in">cd</span> <span class="variable">${TUTROOT}</span>/build</span><br><span class="line">&gt;&gt;&gt; pytest ../tut3_pymtl/sort/SortUnitFL_test.py -v</span><br></pre></td></tr></table></figure></div>


<ul>
<li>运行基本测试：</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; pytest ../tut3_pymtl/sort/SortUnitFL_test.py -k test_basic -s</span><br></pre></td></tr></table></figure></div>

<ul>
<li>运行随机测试：</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; pytest ../tut3_pymtl/sort/SortUnitFL_test.py -k test_random -s</span><br></pre></td></tr></table></figure></div>

<p>如前面所述，FL模型有如下几个最直接的作用：</p>
<ol>
<li>早期验证：FL 模型可以快速实现并验证硬件设计的基本功能，为后续的 CL 和 RTL 模型提供测试基准。</li>
<li>模块化设计：通过 FL 模型验证功能后，可在更高抽象级别逐步优化和细化设计。</li>
<li>代码复用性：在 FL 模型中完成的测试用例可以直接复用于 CL 和 RTL 模型，确保验证过程一致。</li>
</ol>
<p>这是实际的输出结果：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">(pymtl3_env) (usr) albert@alberts-fedora:~/CSC/cpt5$ pytest SortUnitFL_test.py -v -s</span><br><span class="line">======================================================== <span class="built_in">test</span> session starts =========================================================</span><br><span class="line">platform linux -- Python 3.8.20, pytest-7.2.0, pluggy-1.5.0 -- /home/albert/.conda/envs/pymtl3_env/bin/python3.8</span><br><span class="line">cachedir: .pytest_cache</span><br><span class="line">hypothesis profile <span class="string">'default'</span> -&gt; database=DirectoryBasedExampleDatabase(PosixPath(<span class="string">'/home/albert/CSC/cpt5/.hypothesis/examples'</span>))</span><br><span class="line">rootdir: /home/albert/CSC/cpt5</span><br><span class="line">plugins: hypothesis-6.113.0, pymtl3-3.1.16</span><br><span class="line">collected 2 items                                                                                                                    </span><br><span class="line"></span><br><span class="line">SortUnitFL_test.py::test_basic </span><br><span class="line">  1r              |             </span><br><span class="line">  2r              |             </span><br><span class="line">  3:              |             </span><br><span class="line">  4: {08,03,05,01}|             </span><br><span class="line">  5:              |{01,03,05,08}</span><br><span class="line">  6:              |             </span><br><span class="line">  7:              |             </span><br><span class="line">  8:              |             </span><br><span class="line">PASSED</span><br><span class="line">SortUnitFL_test.py::test_random </span><br><span class="line">  1r              |             </span><br><span class="line">  2r              |             </span><br><span class="line">  3:              |             </span><br><span class="line">  4: {b2,b2,65,73}|             </span><br><span class="line">  5:              |{65,73,b2,b2}</span><br><span class="line">  6: {9c,0b,09,fd}|             </span><br><span class="line">  7:              |{09,0b,9c,fd}</span><br><span class="line">  8: {0e,39,e4,c8}|             </span><br><span class="line">  9:              |{0e,39,c8,e4}</span><br><span class="line"> 10: {79,63,11,b4}|             </span><br><span class="line"> 11:              |{11,63,79,b4}</span><br><span class="line"> 12: {b2,d5,27,8d}|             </span><br><span class="line"> 13:              |{27,8d,b2,d5}</span><br><span class="line"> 14: {89,2e,b6,11}|             </span><br><span class="line"> 15:              |{11,2e,89,b6}</span><br><span class="line"> 16: {fb,06,4b,07}|             </span><br><span class="line"> 17:              |{06,07,4b,fb}</span><br><span class="line"> 18: {ce,79,a1,cb}|             </span><br><span class="line"> 19:              |{79,a1,cb,ce}</span><br><span class="line"> 20: {93,07,d4,b9}|             </span><br><span class="line"> 21:              |{07,93,b9,d4}</span><br><span class="line"> 22: {ca,aa,9f,29}|             </span><br><span class="line"> 23:              |{29,9f,aa,ca}</span><br><span class="line"> 24: {93,98,7c,7c}|             </span><br><span class="line"> 25:              |{7c,7c,93,98}</span><br><span class="line"> 26: {33,16,99,f8}|             </span><br><span class="line"> 27:              |{16,33,99,f8}</span><br><span class="line"> 28: {60,78,26,d7}|             </span><br><span class="line"> 29:              |{26,60,78,d7}</span><br><span class="line"> 30: {d2,c7,75,66}|             </span><br><span class="line"> 31:              |{66,75,c7,d2}</span><br><span class="line"> 32: {bf,08,cc,22}|             </span><br><span class="line"> 33:              |{08,22,bf,cc}</span><br><span class="line"> 34: {15,45,d0,e2}|             </span><br><span class="line"> 35:              |{15,45,d0,e2}</span><br><span class="line"> 36: {98,91,00,70}|             </span><br><span class="line"> 37:              |{00,70,91,98}</span><br><span class="line"> 38: {f4,5d,f7,1e}|             </span><br><span class="line"> 39:              |{1e,5d,f4,f7}</span><br><span class="line"> 40: {da,ef,ab,64}|             </span><br><span class="line"> 41:              |{64,ab,da,ef}</span><br><span class="line"> 42: {78,03,9f,6b}|             </span><br><span class="line"> 43:              |{03,6b,78,9f}</span><br><span class="line"> 44:              |             </span><br><span class="line"> 45:              |             </span><br><span class="line"> 46:              |             </span><br><span class="line">PASSED</span><br><span class="line"></span><br><span class="line">========================================================= 2 passed <span class="keyword">in</span> 0.72s ==========================================================</span><br></pre></td></tr></table></figure></div>

<h3 id="5-2-排序单元的-CL-模型"><a href="#5-2-排序单元的-CL-模型" class="headerlink" title="5.2 排序单元的 CL 模型"></a>5.2 排序单元的 CL 模型</h3><p>在 FL（功能级）模型的基础上，我们可以逐步将其细化为 CL（周期级）模型。CL 模型捕获硬件目标的周期近似行为，关注其在每个时钟周期内的性能表现，而不是单纯的功能正确性。</p>
<p>CL 模型在第一周期完成输入值的排序，并使用流水线模拟目标硬件的周期延迟。如 Figure 30 所示：</p>
<ul>
<li>输入端口 in_ 和 in_val 提供值及其有效性标志。</li>
<li>排序逻辑在第一周期内完成值的排序。</li>
<li>使用 pipe（双端队列）模拟流水线延迟，将排序结果在多个周期内逐步输出。</li>
<li>输出端口 out_ 和 out_val 提供按顺序排列的结果及其有效性。</li>
</ul>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24112002.png" alt="24112002"></p>
<p>以下代码展示了排序单元 CL 模型的具体实现，重点在于使用流水线结构模拟硬件的延迟:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="keyword">from</span> copy <span class="keyword">import</span> deepcopy</span><br><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> .SortUnitFL <span class="keyword">import</span> sort_fl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排序单元 CL 模型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SortUnitCL</span>(<span class="title class_ inherited__">Component</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造函数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">construct</span>(<span class="params">s, nbits=<span class="number">8</span>, nstages=<span class="number">3</span></span>):</span><br><span class="line">        <span class="comment"># 定义输入端口</span></span><br><span class="line">        s.in_val = InPort()</span><br><span class="line">        s.in_ = [InPort(nbits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 定义输出端口</span></span><br><span class="line">        s.out_val = OutPort()</span><br><span class="line">        s.out = [OutPort(nbits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化流水线队列</span></span><br><span class="line">        s.pipe = deque([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]] * (nstages - <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 更新块：核心排序与流水线逻辑</span></span><br><span class="line"><span class="meta">        @update_ff</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">block</span>():</span><br><span class="line">            <span class="comment"># 将输入值与有效性标志排序后存入队列</span></span><br><span class="line">            s.pipe.append(deepcopy([s.in_val] + sort_fl(s.in_)))</span><br><span class="line">            <span class="comment"># 从队列中取出最早的值</span></span><br><span class="line">            data = s.pipe.popleft()</span><br><span class="line">            <span class="comment"># 更新输出端口</span></span><br><span class="line">            s.out_val &lt;&lt;= data[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(data[<span class="number">1</span>:]):</span><br><span class="line">                s.out[i] &lt;&lt;= v</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 行跟踪（显示输入输出状态）</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">line_trace</span>(<span class="params">s</span>):</span><br><span class="line">        <span class="comment"># 输入状态字符串</span></span><br><span class="line">        in_str = <span class="string">'{'</span> + <span class="string">','</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, s.in_)) + <span class="string">'}'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> s.in_val:</span><br><span class="line">            in_str = <span class="string">' '</span> * <span class="built_in">len</span>(in_str)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 输出状态字符串</span></span><br><span class="line">        out_str = <span class="string">'{'</span> + <span class="string">','</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, s.out)) + <span class="string">'}'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> s.out_val:</span><br><span class="line">            out_str = <span class="string">' '</span> * <span class="built_in">len</span>(out_str)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 返回格式化的输入输出状态</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"<span class="subst">{in_str}</span>|<span class="subst">{out_str}</span>"</span></span><br></pre></td></tr></table></figure></div>

<p>代码解释：</p>
<ol>
<li>双端队列 <code>pipe</code> 的作用</li>
</ol>
<p>双端队列（<code>deque</code>）是 Python 标准库 <code>collections</code> 模块中的一种数据结构，用于高效地在序列两端添加或删除元素。</p>
<ul>
<li>模拟流水线延迟：<br>在硬件中，流水线的延迟表现为信号从输入端逐步传播到输出端的过程。在这个 CL 模型中，<code>pipe</code> 作为一个双端队列，用于存储每个时钟周期的输入有效信号 <code>in_val</code> 和排序后的数据列表 <code>sort_fl(s.in_)</code>。</li>
<li>元素格式：<br>队列的每个元素是一个列表，包含有效性标志 <code>in_val</code> 和排序结果 <code>[sorted_value1, sorted_value2, sorted_value3, sorted_value4]</code>。例如：</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]  <span class="comment"># 1 是有效信号，2–5 是排序后的值</span></span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li>模拟延迟逻辑</li>
</ol>
<p>在每个时钟周期：</p>
<ul>
<li>调用 <code>append</code> 方法将新的输入有效信号和排序后的数据加入队列末尾。</li>
<li>调用 <code>popleft</code> 方法从队列头部取出最早的信号值和数据，用于更新输出端口。</li>
<li>初始化长度：<br>队列的初始长度为 <code>nstages - 1</code>（流水线的阶段数减一）。例如，当 <code>nstages=3</code> 时，初始队列长度为 2。这种设计在 <code>nstages=1</code> 时（单周期延迟）能够直接运行，不会增加额外的延迟。</li>
</ul>
<ol start="3">
<li>深拷贝 <code>deepcopy</code></li>
</ol>
<p>Python 的赋值操作默认是引用传递，这意味着多个变量可能同时指向同一个对象。如果直接将输入信号和排序后的结果添加到队列中，可能会出现以下问题：</p>
<ul>
<li>信号值在后续周期被修改时，队列中存储的值也会随之改变。</li>
<li>导致信号不稳定或与预期不符。</li>
</ul>
<p>解决方案：</p>
<ul>
<li>使用 <code>copy</code> 模块中的 <code>deepcopy</code> 函数对信号和排序结果进行深度拷贝，生成一个独立的副本。</li>
<li>深拷贝确保了队列中的值与输入信号完全独立，避免了因共享内存而引发的副作用。例如：</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s.pipe.append(deepcopy([s.in_val] + sort_fl(s.in_)))</span><br></pre></td></tr></table></figure></div>

<ol start="4">
<li>更新块逻辑</li>
</ol>
<p>更新块是通过 <code>@update_ff</code> 装饰器定义的同步逻辑，它在每个时钟上升沿被调用，模拟硬件中寄存器的行为。</p>
<p>排序与存储：</p>
<ul>
<li>调用 <code>sort_fl(s.in_)</code> 函数对输入信号列表 <code>s.in_</code> 进行排序。</li>
<li>使用深拷贝将输入有效信号 <code>s.in_val</code> 和排序后的列表组合后追加到队列末尾。</li>
</ul>
<p>队列的读取：</p>
<ul>
<li>调用 <code>popleft</code> 从队列头部取出最早的信号值和数据。</li>
<li>将有效性标志 <code>data[0]</code> 赋值给输出端口 <code>s.out_val</code>，并将排序后的数据列表赋值给输出数据端口 <code>s.out[i]</code>。</li>
</ul>
<p>流水线延迟：</p>
<ul>
<li>队列的长度为 <code>nstages - 1</code>，每次调用 <code>append</code> 和 <code>popleft</code> 操作都会导致数据沿着流水线推进一段距离。</li>
<li>如果 <code>nstages=3</code>，则总延迟为 3 个周期（包括更新块本身的 1 个周期延迟）。</li>
</ul>
<ol start="5">
<li>行跟踪（Line Trace）</li>
</ol>
<p>行跟踪用于在测试和调试过程中直观地展示输入和输出信号的变化。</p>
<ul>
<li>显示输入状态：</li>
<li>将输入端口 <code>s.in_</code> 的值通过 <code>map</code> 和 <code>str</code> 转换为字符串，并用花括号包裹。</li>
<li>当 <code>in_val</code> 无效时，用空格替代对应的字符串，以清晰显示无效周期。例如：</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">in_str = <span class="string">'{'</span> + <span class="string">','</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, s.in_)) + <span class="string">'}'</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> s.in_val:</span><br><span class="line">    in_str = <span class="string">' '</span> * <span class="built_in">len</span>(in_str)</span><br></pre></td></tr></table></figure></div>

<p>显示输出状态：</p>
<ul>
<li>将输出端口 <code>s.out</code> 的值转换为字符串，同样在无效周期中用空格替代。</li>
<li>输出字符串与输入字符串通过<code>|</code>分隔，表示输入输出之间的关系。</li>
<li>输出格式：<br>行跟踪的结果是一个固定宽度的字符串，便于观察信号的传递。例如：</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">{04,02,03,01}|         <span class="comment"># 第 4 周期：输入有效，输出无效</span></span><br><span class="line">             |{01,02,03,04}  <span class="comment"># 第 7 周期：输入无效，输出有效</span></span><br></pre></td></tr></table></figure></div>

<p>代码逻辑图解</p>
<ol>
<li>初始化队列：</li>
</ol>
<ul>
<li>假设 <code>nstages=3</code>，则队列初始状态为：</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[0, 0, 0, 0, 0], [0, 0, 0, 0, 0]]  <span class="comment"># 两个占位元素</span></span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li>周期操作：</li>
</ol>
<ul>
<li>周期 1：输入 <code>{4, 2, 3, 1}</code>，排序后追加队列：</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[0, 0, 0, 0, 0], [1, 1, 2, 3, 4]]</span><br></pre></td></tr></table></figure></div>


<ul>
<li><p>周期 2：从队列头部取出一个值更新输出，同时追加新输入。</p>
</li>
<li><p>周期 3：队列状态为：</p>
</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[1, 1, 2, 3, 4]]</span><br></pre></td></tr></table></figure></div>

<p>输出 <code>{1, 2, 3, 4}</code>。</p>
<p>CL 模型的测试使用参数化测试，包括<strong>定向测试</strong>和<strong>随机测试</strong>，覆盖了不同输入值和不同流水线深度。</p>
<p>测试示例代码</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pymtl3.stdlib.test_utils <span class="keyword">import</span> run_test_vector_sim</span><br><span class="line"><span class="keyword">from</span> SortUnitCL <span class="keyword">import</span> SortUnitCL</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试函数：三阶段流水线</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_3stage_stream</span>(<span class="params">cmdline_opts</span>):</span><br><span class="line">    run_test_vector_sim(SortUnitCL(nstages=<span class="number">3</span>), [</span><br><span class="line">        (<span class="string">'in_val in_[0] in_[1] in_[2] in_[3] out_val out[0] out[1] out[2] out[3]*'</span>),</span><br><span class="line">        [ <span class="number">1</span>,      <span class="number">4</span>,    <span class="number">2</span>,    <span class="number">3</span>,    <span class="number">1</span>,    <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>       ],</span><br><span class="line">        [ <span class="number">0</span>,      <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>       ],</span><br><span class="line">        [ <span class="number">0</span>,      <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>,     <span class="number">0</span>       ],</span><br><span class="line">        [ <span class="number">0</span>,      <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">0</span>,    <span class="number">1</span>,     <span class="number">1</span>,     <span class="number">2</span>,     <span class="number">3</span>,     <span class="number">4</span>       ],</span><br><span class="line">    ], cmdline_opts)</span><br></pre></td></tr></table></figure></div>

<ul>
<li>运行所有测试：</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="built_in">cd</span> <span class="variable">${TUTROOT}</span>/build</span><br><span class="line">&gt;&gt;&gt; pytest ../tut3_pymtl/sort/test/SortUnitCL_test.py -v</span><br></pre></td></tr></table></figure></div>

<ul>
<li>运行特定测试：</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; pytest ../tut3_pymtl/sort/test/SortUnitCL_test.py -k 3stage_stream -s</span><br></pre></td></tr></table></figure></div>

<p>Figure 32 显示了测试的行跟踪输出：</p>
<ul>
<li>第 3 周期：无输入和输出。</li>
<li>第 4 周期：输入值 <code>{4, 2, 3, 1}</code> 被记录。</li>
<li>第 7 周期：输出值 <code>{1, 2, 3, 4}</code> 被排序后输出。</li>
</ul>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24112003.png" alt="24112003"></p>
<p>这是实际输出结果：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(pymtl3_env) (usr) albert@alberts-fedora:~/CSC/cpt5$ pytest SortUnitCL_test.py -v -s</span><br><span class="line">============================================== <span class="built_in">test</span> session starts ==============================================</span><br><span class="line">platform linux -- Python 3.8.20, pytest-7.2.0, pluggy-1.5.0 -- /home/albert/.conda/envs/pymtl3_env/bin/python3.8</span><br><span class="line">cachedir: .pytest_cache</span><br><span class="line">hypothesis profile <span class="string">'default'</span> -&gt; database=DirectoryBasedExampleDatabase(PosixPath(<span class="string">'/home/albert/CSC/cpt5/.hypothesis/examples'</span>))</span><br><span class="line">rootdir: /home/albert/CSC/cpt5</span><br><span class="line">plugins: hypothesis-6.113.0, pymtl3-3.1.16</span><br><span class="line">collected 1 item                                                                                                </span><br><span class="line"></span><br><span class="line">SortUnitCL_test.py::test_3stage_stream </span><br><span class="line">  1r              |             </span><br><span class="line">  2r              |             </span><br><span class="line">  3: {04,02,03,01}|             </span><br><span class="line">  4:              |             </span><br><span class="line">  5:              |             </span><br><span class="line">  6:              |{01,02,03,04}</span><br><span class="line">  7:              |             </span><br><span class="line">  8:              |             </span><br><span class="line">  9:              |             </span><br><span class="line">PASSED</span><br><span class="line"></span><br><span class="line">=============================================== 1 passed <span class="keyword">in</span> 0.72s ===============================================</span><br></pre></td></tr></table></figure></div>

<p>此结果验证了 CL 模型正确捕获了排序单元的周期行为。</p>
<h3 id="5-3-排序单元的-RTL-模型"><a href="#5-3-排序单元的-RTL-模型" class="headerlink" title="5.3 排序单元的 RTL 模型"></a>5.3 排序单元的 RTL 模型</h3><p>在完成了对功能级（FL）和周期级（CL）模型的探索后，我们将设计进一步深化为RTL模型（寄存器传输级模型）。RTL模型具备以下特性：</p>
<ul>
<li>周期准确性：严格模拟硬件的周期行为。</li>
<li>资源准确性：具体实现硬件所需的资源，包括寄存器、比较器等。</li>
<li>位级准确性：每一位的操作符合硬件逻辑。</li>
</ul>
<p>在本节中，我们实现了一个三级流水线的排序单元，采用了Bitonic排序网络进行四个输入值的排序。以下为模型设计的详细说明。</p>
<p>如图（Figure 33）所示，RTL模型使用三级流水线，每一级实现部分排序，逐步将输入数据排序为输出数据。其中，每个流水线阶段包含：</p>
<ol>
<li>数据的输入寄存器化。</li>
<li>min/max单元：对两个输入进行比较，较小值输出至上方端口，较大值输出至下方端口。</li>
</ol>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24112101.png" alt="24112101"></p>
<p>排序网络是三级流水线实现的Bitonic网络：</p>
<ul>
<li>第一阶段（S1）：分别比较元素对 <code>(0,1)</code> 和 <code>(2,3)</code>。</li>
<li>第二阶段（S2）：分别比较元素对 <code>(0,2)</code> 和 <code>(1,3)</code>。</li>
<li>第三阶段（S3）：比较元素对 <code>(1,2)</code>。</li>
</ul>
<p>最终结果在第七个时钟周期输出，保证了模型的流水线周期级行为。</p>
<p>设计原则:</p>
<ul>
<li>输入寄存器化（Registered Inputs）：每个流水线阶段的输入均通过寄存器进行存储，以避免关键路径延迟。</li>
<li>清晰的阶段划分：每一级流水线的逻辑清晰分离，使用寄存器存储每一级的结果。</li>
<li>复位信号显式处理：RTL模型中所有状态均需显式复位，确保在硬件初始化时的正确性。</li>
</ul>
<p>以下为排序单元RTL模型的部分代码实现，展示了接口定义、输入寄存器化及第一阶段（S1）的组合逻辑：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SortUnitFlatRTL</span>(<span class="title class_ inherited__">Component</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">construct</span>(<span class="params">s, nbits=<span class="number">8</span></span>):</span><br><span class="line">        <span class="comment"># 接口定义</span></span><br><span class="line">        s.in_val = InPort()                      <span class="comment"># 输入有效信号</span></span><br><span class="line">        s.in_ = [InPort(nbits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)] <span class="comment"># 输入端口数组</span></span><br><span class="line">        s.out_val = OutPort()                    <span class="comment"># 输出有效信号</span></span><br><span class="line">        s.out = [OutPort(nbits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)] <span class="comment"># 输出端口数组</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 第一阶段输入寄存器（S0 -&gt; S1）</span></span><br><span class="line">        s.val_S1 = Wire()                          <span class="comment"># 有效性信号寄存器</span></span><br><span class="line">        s.elm_S1 = [Wire(nbits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)] <span class="comment"># 数据寄存器</span></span><br><span class="line"></span><br><span class="line"><span class="meta">        @update_ff</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">pipereg_S0S1</span>():</span><br><span class="line">            <span class="keyword">if</span> s.reset:</span><br><span class="line">                s.val_S1 &lt;&lt;= <span class="number">0</span>                    <span class="comment"># 复位时清零有效性信号</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                s.val_S1 &lt;&lt;= s.in_val             <span class="comment"># 正常传递有效性信号</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):                    <span class="comment"># 输入数据存入寄存器</span></span><br><span class="line">                s.elm_S1[i] &lt;&lt;= s.in_[i]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 第一阶段组合逻辑（S1）</span></span><br><span class="line">        s.elm_next_S1 = [Wire(nbits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)] <span class="comment"># 下一阶段数据</span></span><br><span class="line"></span><br><span class="line"><span class="meta">        @update</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">stage_S1</span>():</span><br><span class="line">            <span class="comment"># 比较输入数据对 (0,1)</span></span><br><span class="line">            <span class="keyword">if</span> s.elm_S1[<span class="number">0</span>] &lt;= s.elm_S1[<span class="number">1</span>]:</span><br><span class="line">                s.elm_next_S1[<span class="number">0</span>] @= s.elm_S1[<span class="number">0</span>]</span><br><span class="line">                s.elm_next_S1[<span class="number">1</span>] @= s.elm_S1[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                s.elm_next_S1[<span class="number">0</span>] @= s.elm_S1[<span class="number">1</span>]</span><br><span class="line">                s.elm_next_S1[<span class="number">1</span>] @= s.elm_S1[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 比较输入数据对 (2,3)</span></span><br><span class="line">            <span class="keyword">if</span> s.elm_S1[<span class="number">2</span>] &lt;= s.elm_S1[<span class="number">3</span>]:</span><br><span class="line">                s.elm_next_S1[<span class="number">2</span>] @= s.elm_S1[<span class="number">2</span>]</span><br><span class="line">                s.elm_next_S1[<span class="number">3</span>] @= s.elm_S1[<span class="number">3</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                s.elm_next_S1[<span class="number">2</span>] @= s.elm_S1[<span class="number">3</span>]</span><br><span class="line">                s.elm_next_S1[<span class="number">3</span>] @= s.elm_S1[<span class="number">2</span>]</span><br></pre></td></tr></table></figure></div>

<p>代码解释：</p>
<ol>
<li>接口定义</li>
</ol>
<ul>
<li><code>s.in_val</code> 和 <code>s.out_val</code> 是布尔型信号，分别表示输入有效性和输出有效性。</li>
<li><code>s.in_</code> 和 <code>s.out</code> 是四个输入和输出数据端口，位宽可通过参数 nbits 定义。</li>
</ul>
<ol start="2">
<li>输入寄存器化</li>
</ol>
<ul>
<li>使用 <code>update_ff</code> 模拟寄存器行为。</li>
<li>每个时钟周期，将输入有效性信号 <code>s.in_val</code> 和输入数据 <code>s.in_</code> 存储到寄存器中。</li>
<li>在复位信号激活时，将所有寄存器清零。</li>
</ul>
<ol start="3">
<li>第一阶段组合逻辑</li>
</ol>
<ul>
<li>通过 <code>update</code> 定义组合逻辑。</li>
<li>比较输入数据对 <code>(0,1)</code> 和 <code>(2,3)</code>，将较小值存储到上方端口，较大值存储到下方端口。</li>
<li>输出结果存储在 <code>s.elm_next_S1</code> 中，供下一阶段使用。</li>
</ul>
<p>测试脚本包含以下内容：</p>
<ul>
<li>四个定向测试（directed tests）。</li>
<li>一个随机测试（random test）。</li>
</ul>
<p>这是参考的测试脚本：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pymtl3.stdlib.test_utils <span class="keyword">import</span> run_test_vector_sim</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> SortUnitFlatRTL <span class="keyword">import</span> SortUnitFlatRTL  <span class="comment"># 引入待测模块</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_sort_unit_flatrtl</span>(<span class="params">cmdline_opts</span>):</span><br><span class="line">    <span class="comment"># 定义测试向量</span></span><br><span class="line">    test_vectors = [</span><br><span class="line">        (<span class="string">'in_val in_[0] in_[1] in_[2] in_[3] out_val out[0] out[1] out[2] out[3]'</span>),</span><br><span class="line">        <span class="comment"># 初始阶段，输入信号无效，但输入必须为合法值（如全为 0）</span></span><br><span class="line">        [  <span class="number">0</span>,      <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">0</span>,      <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">0x00</span> ],</span><br><span class="line">        <span class="comment"># 输入第一组数据，排序结果不可用</span></span><br><span class="line">        [  <span class="number">1</span>,      <span class="number">0x03</span>,   <span class="number">0x09</span>,   <span class="number">0x04</span>,   <span class="number">0x01</span>,   <span class="number">0</span>,      <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">0x00</span> ],</span><br><span class="line">        <span class="comment"># 第一阶段寄存器传递数据</span></span><br><span class="line">        [  <span class="number">0</span>,      <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">1</span>,      <span class="number">0x01</span>,   <span class="number">0x03</span>,   <span class="number">0x04</span>,   <span class="number">0x09</span> ],</span><br><span class="line">        <span class="comment"># 输入第二组数据，排序结果不可用</span></span><br><span class="line">        [  <span class="number">1</span>,      <span class="number">0x10</span>,   <span class="number">0x20</span>,   <span class="number">0x15</span>,   <span class="number">0x05</span>,   <span class="number">0</span>,      <span class="number">0x01</span>,   <span class="number">0x03</span>,   <span class="number">0x04</span>,   <span class="number">0x09</span> ],</span><br><span class="line">        <span class="comment"># 第二组排序完成</span></span><br><span class="line">        [  <span class="number">0</span>,      <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">0x00</span>,   <span class="number">1</span>,      <span class="number">0x05</span>,   <span class="number">0x10</span>,   <span class="number">0x15</span>,   <span class="number">0x20</span> ],</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 运行测试</span></span><br><span class="line">    run_test_vector_sim(SortUnitFlatRTL(), test_vectors, cmdline_opts, print_line_trace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></div>

<p>运行测试命令如下：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">% <span class="built_in">cd</span> <span class="variable">${TUTROOT}</span>/build</span><br><span class="line">% pytest ../tut3_pymtl/sort/test/SortUnitFlatRTL_test.py -v</span><br><span class="line">% pytest ../tut3_pymtl/sort/test/SortUnitFlatRTL_test.py -k test_basic -s</span><br></pre></td></tr></table></figure></div>

<p>输出行跟踪如下（Figure 35）：</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/image/24112102.png" alt="24112102"></p>
<p>这是实际的输出：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(pymtl3_env) (usr) albert@alberts-fedora:~/CSC/cpt5$ pytest SortUnitFlatRTL_test.py -v -s</span><br><span class="line">============================================== <span class="built_in">test</span> session starts ==============================================</span><br><span class="line">platform linux -- Python 3.8.20, pytest-7.2.0, pluggy-1.5.0 -- /home/albert/.conda/envs/pymtl3_env/bin/python3.8</span><br><span class="line">cachedir: .pytest_cache</span><br><span class="line">hypothesis profile <span class="string">'default'</span> -&gt; database=DirectoryBasedExampleDatabase(PosixPath(<span class="string">'/home/albert/CSC/cpt5/.hypothesis/examples'</span>))</span><br><span class="line">rootdir: /home/albert/CSC/cpt5</span><br><span class="line">plugins: hypothesis-6.113.0, pymtl3-3.1.16</span><br><span class="line">collected 1 item                                                                                                </span><br><span class="line"></span><br><span class="line">SortUnitFlatRTL_test.py::test_sort_unit_flatrtl </span><br><span class="line">  1r in_val: 0 <span class="keyword">in</span>: [00,00,00,00] | out_val: 0 out: [00,00,00,00]</span><br><span class="line">  2r in_val: 0 <span class="keyword">in</span>: [00,00,00,00] | out_val: 0 out: [00,00,00,00]</span><br><span class="line">  3: in_val: 0 <span class="keyword">in</span>: [00,00,00,00] | out_val: 0 out: [00,00,00,00]</span><br><span class="line">  4: in_val: 1 <span class="keyword">in</span>: [03,09,04,01] | out_val: 0 out: [00,00,00,00]</span><br><span class="line">  5: in_val: 0 <span class="keyword">in</span>: [00,00,00,00] | out_val: 1 out: [01,03,04,09]</span><br><span class="line">  6: in_val: 1 <span class="keyword">in</span>: [10,20,15,05] | out_val: 0 out: [01,03,04,09]</span><br><span class="line">  7: in_val: 0 <span class="keyword">in</span>: [00,00,00,00] | out_val: 1 out: [05,10,15,20]</span><br><span class="line">  8: in_val: 0 <span class="keyword">in</span>: [00,00,00,00] | out_val: 1 out: [05,10,15,20]</span><br><span class="line">  9: in_val: 0 <span class="keyword">in</span>: [00,00,00,00] | out_val: 1 out: [05,10,15,20]</span><br><span class="line"> 10: in_val: 0 <span class="keyword">in</span>: [00,00,00,00] | out_val: 1 out: [05,10,15,20]</span><br><span class="line">PASSED</span><br><span class="line"></span><br><span class="line">=============================================== 1 passed <span class="keyword">in</span> 0.77s ===============================================</span><br></pre></td></tr></table></figure></div>

<h3 id="5-4-基于结构化-RTL-模型的排序单元"><a href="#5-4-基于结构化-RTL-模型的排序单元" class="headerlink" title="5.4 基于结构化 RTL 模型的排序单元"></a>5.4 基于结构化 RTL 模型的排序单元</h3><p>平面RTL模型虽然可以直接实现排序单元，但其设计复杂且代码单一，难以有效利用排序器内部的层次化结构。在这一节中，我们采用结构化RTL模型，通过模块化和层次化的设计方法，将复杂设计分解为多个子模块。这种方法的主要优点包括：</p>
<ul>
<li>可维护性：通过模块化分离复杂功能，降低了设计和测试的复杂性。</li>
<li>独立测试：每个子模块可以独立开发和测试，从而提高整体模型的可靠性。</li>
<li>代码清晰性：层次化的设计使得代码更易读且逻辑清晰。</li>
</ul>
<p>它的设计思想如下：</p>
<ol>
<li>结构化设计：</li>
</ol>
<ul>
<li>使用寄存器存储流水线中每个阶段的中间状态。</li>
<li>将排序逻辑封装到独立的<strong>最小-最大单元（MinMaxUnit）</strong>中。</li>
</ul>
<ol start="2">
<li>模块化流水线：</li>
</ol>
<ul>
<li>每个流水线阶段由寄存器和组合逻辑组成。</li>
<li>数据从一个阶段流入下一个阶段，同时每个阶段执行特定的排序逻辑。</li>
</ul>
<ol start="3">
<li>测试可复用性：</li>
</ol>
<ul>
<li>测试脚本可共享之前的测试向量和测试工具，提高测试效率。</li>
</ul>
<p>以下是排序单元结构化RTL模型的代码（以第一个流水线阶段为例）：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pymtl3.stdlib.basic_rtl <span class="keyword">import</span> Reg, RegRst</span><br><span class="line"><span class="keyword">from</span> MinMaxUnit <span class="keyword">import</span> MinMaxUnit  <span class="comment"># 引入最小-最大单元模块</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SortUnitStructRTL</span>(<span class="title class_ inherited__">Component</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">construct</span>(<span class="params">s, nbits=<span class="number">8</span></span>):</span><br><span class="line">        <span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line">        <span class="comment"># 接口定义</span></span><br><span class="line">        <span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line">        s.in_val = InPort()  <span class="comment"># 输入有效信号</span></span><br><span class="line">        s.in_ = [InPort(nbits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]  <span class="comment"># 4个输入端口，每个宽度为nbits</span></span><br><span class="line">        s.out_val = OutPort()  <span class="comment"># 输出有效信号</span></span><br><span class="line">        s.out = [OutPort(nbits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]  <span class="comment"># 4个输出端口</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line">        <span class="comment"># Stage S0-&gt;S1: 流水线寄存器</span></span><br><span class="line">        <span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line">        <span class="comment"># 输入有效信号寄存器化（带复位功能）</span></span><br><span class="line">        s.val_S0S1 = RegRst(Bits1)  </span><br><span class="line">        s.val_S0S1.in_ //= s.in_val  <span class="comment"># 将输入有效信号连接到寄存器输入</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 输入数据寄存器化</span></span><br><span class="line">        s.elm_S0S1 = [Reg(mk_bits(nbits)) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            s.elm_S0S1[i].in_ //= s.in_[i]  <span class="comment"># 将每个输入端口连接到对应寄存器的输入端口</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line">        <span class="comment"># Stage S1: 组合逻辑（最小-最大排序单元）</span></span><br><span class="line">        <span class="comment"># ---------------------------------------------------------------------</span></span><br><span class="line">        <span class="comment"># 第一组比较单元</span></span><br><span class="line">        s.minmax0_S1 = m = MinMaxUnit(nbits)  <span class="comment"># 实例化一个最小-最大单元</span></span><br><span class="line">        m.in0 //= s.elm_S0S1[<span class="number">0</span>].out  <span class="comment"># 第1个寄存器的输出连接到最小-最大单元的输入0</span></span><br><span class="line">        m.in1 //= s.elm_S0S1[<span class="number">1</span>].out  <span class="comment"># 第2个寄存器的输出连接到最小-最大单元的输入1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 第二组比较单元</span></span><br><span class="line">        s.minmax1_S1 = m = MinMaxUnit(nbits)</span><br><span class="line">        m.in0 //= s.elm_S0S1[<span class="number">2</span>].out</span><br><span class="line">        m.in1 //= s.elm_S0S1[<span class="number">3</span>].out</span><br></pre></td></tr></table></figure></div>

<p>代码详解:</p>
<ol>
<li>接口定义：</li>
</ol>
<ul>
<li>定义了一个输入有效信号端口<code>in_val</code>和一个输出有效信号端口<code>out_val</code>，用于指示输入数据和输出数据的有效性。</li>
<li>定义了4个输入端口<code>in_</code>和4个输出端口<code>out</code>，每个端口的位宽为<code>nbits</code>（默认为8位）。</li>
</ul>
<ol start="2">
<li>流水线寄存器（Stage S0-&gt;S1）：</li>
</ol>
<ul>
<li>使用RegRst寄存器存储输入有效信号（<code>in_val</code>），并支持复位功能。</li>
<li>使用4个普通寄存器（<code>Reg</code>）存储输入数据，每个寄存器分别对应4个输入端口。</li>
<li>通过//=操作符连接寄存器的输入和接口的输入，实现信号的直连。</li>
</ul>
<ol start="3">
<li>组合逻辑（<code>Stage S1</code>）：</li>
</ol>
<ul>
<li>实例化两个最小-最大比较单元（MinMaxUnit），每个单元比较两个输入数据并输出较小值和较大值。</li>
<li>第一组比较单元（<code>minmax0_S1</code>）比较寄存器<code>elm_S0S1[0]</code>和<code>elm_S0S1[1]</code>的输出数据。</li>
<li>第二组比较单元（<code>minmax1_S1</code>）比较寄存器<code>elm_S0S1[2]</code>和<code>elm_S0S1[3]</code>的输出数据。</li>
</ul>
<ol start="4">
<li>模块间连接：</li>
</ol>
<ul>
<li>使用<code>//=</code>操作符将寄存器输出连接到比较单元输入，避免声明中间信号，简化代码。</li>
</ul>
<p>测试脚本:</p>
<p>结构化RTL模型的测试脚本包含以下几个关键点：</p>
<ol>
<li>测试脚本复用：</li>
</ol>
<ul>
<li>使用SortUnitCL_test.py中的<code>mk_test_vector_table</code>生成测试向量，从而复用已有的测试逻辑。</li>
</ul>
<ol start="2">
<li>测试用例：</li>
</ol>
<ul>
<li>包含四个定向测试（directed tests）和一个随机测试（random test），覆盖了排序单元的主要功能。</li>
</ul>
<ol start="3">
<li>运行测试：</li>
</ol>
<ul>
<li>执行所有测试：</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">${TUTROOT}</span>/build</span><br><span class="line">pytest ../tut3_pymtl/sort/test/SortUnitStructRTL_test.py -v</span><br></pre></td></tr></table></figure></div>


<ul>
<li>查看基本测试的行跟踪：</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pytest ../tut3_pymtl/sort/test/SortUnitStructRTL_test.py -k test_basic -s</span><br></pre></td></tr></table></figure></div>

<h3 id="5-5-使用模拟器评估排序单元"><a href="#5-5-使用模拟器评估排序单元" class="headerlink" title="5.5 使用模拟器评估排序单元"></a>5.5 使用模拟器评估排序单元</h3><p>在硬件设计中，评估（Evaluation）是验证（Verification）之后的关键一步。评估的核心目标是量化设计性能，例如执行某个输入数据集所需的时钟周期数、平均延迟、吞吐量等。这一步的重点在于使用模拟器而不是单元测试，模拟器通过完整的循环流程运行设计，生成统计数据，而不再关注具体功能是否正确。</p>
<p>模拟器的功能</p>
<ol>
<li>处理命令行参数：通过参数指定实现模型、输入模式等选项。</li>
<li>生成输入数据集：支持多种输入模式（如随机输入、升序输入、降序输入）。</li>
<li>实例化并展开设计：根据指定的实现类型创建模型。</li>
<li>主循环运行设计：驱动输入信号，检测输出有效信号，记录设计行为。</li>
<li>生成性能统计数据：包括总时钟周期数、平均每次排序所需周期数等。</li>
</ol>
<p>以下是简化版模拟器脚本的代码和功能详细说明：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">opts = parse_cmdline()  <span class="comment"># 解析命令行参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------</span></span><br><span class="line"><span class="comment"># 1. 生成输入数据集</span></span><br><span class="line"><span class="comment"># --------------------------</span></span><br><span class="line">ninputs = <span class="number">100</span>  <span class="comment"># 输入数据集大小（可调整）</span></span><br><span class="line">inputs = []  <span class="comment"># 初始化输入数据列表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据命令行参数生成输入数据集</span></span><br><span class="line"><span class="keyword">if</span> opts.<span class="built_in">input</span> == <span class="string">"random"</span>:  <span class="comment"># 随机模式</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ninputs):</span><br><span class="line">        inputs.append([randint(<span class="number">0</span>, <span class="number">0xff</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)])  <span class="comment"># 每组生成4个随机数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------</span></span><br><span class="line"><span class="comment"># 2. 实例化并展开设计</span></span><br><span class="line"><span class="comment"># --------------------------</span></span><br><span class="line">model_impl_dict = {</span><br><span class="line">    <span class="string">'cl'</span>: SortUnitCL,          <span class="comment"># 周期近似模型（Cycle-Level Approximate Model）</span></span><br><span class="line">    <span class="string">'rtl-flat'</span>: SortUnitFlatRTL,  <span class="comment"># 平面RTL模型</span></span><br><span class="line">    <span class="string">'rtl-struct'</span>: SortUnitStructRTL  <span class="comment"># 结构化RTL模型</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">model = model_impl_dict[opts.impl]()  <span class="comment"># 根据命令行参数选择对应模型</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置模拟器的选项</span></span><br><span class="line">unique_name = <span class="string">f"sort-<span class="subst">{opts.impl}</span>-<span class="subst">{opts.<span class="built_in">input</span>}</span>"</span>  <span class="comment"># 唯一标识模拟运行</span></span><br><span class="line">cmdline_opts = {</span><br><span class="line">    <span class="string">'dump_vcd'</span>: <span class="string">f"<span class="subst">{unique_name}</span>"</span> <span class="keyword">if</span> opts.dump_vcd <span class="keyword">else</span> <span class="string">''</span>,  <span class="comment"># 是否生成波形文件</span></span><br><span class="line">    <span class="string">'test_verilog'</span>: <span class="string">'zeros'</span> <span class="keyword">if</span> opts.translate <span class="keyword">else</span> <span class="string">''</span>       <span class="comment"># 是否进行Verilog测试</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置并初始化模型</span></span><br><span class="line">model = config_model_with_cmdline_opts(model, cmdline_opts, duts=[])</span><br><span class="line">model.apply(DefaultPassGroup(linetrace=opts.trace))  <span class="comment"># 添加行跟踪（Line Trace）</span></span><br><span class="line">model.sim_reset()  <span class="comment"># 重置模拟器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------</span></span><br><span class="line"><span class="comment"># 3. 执行主循环</span></span><br><span class="line"><span class="comment"># --------------------------</span></span><br><span class="line">counter = <span class="number">0</span>  <span class="comment"># 记录已处理输出的计数器</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> counter &lt; ninputs:</span><br><span class="line">    <span class="comment"># 记录输出有效信号</span></span><br><span class="line">    <span class="keyword">if</span> model.out_val:  <span class="comment"># 如果输出有效信号为True</span></span><br><span class="line">        counter += <span class="number">1</span>   <span class="comment"># 增加计数器</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 驱动输入信号</span></span><br><span class="line">    <span class="keyword">if</span> inputs:  <span class="comment"># 如果输入队列非空</span></span><br><span class="line">        model.in_val @= <span class="number">1</span>  <span class="comment"># 设置输入有效信号</span></span><br><span class="line">        <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(inputs.pop()):  <span class="comment"># 弹出一组输入数据</span></span><br><span class="line">            model.in_[i] @= v</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        model.in_val @= <span class="number">0</span>  <span class="comment"># 设置输入无效信号</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):  <span class="comment"># 清空输入端口</span></span><br><span class="line">            model.in_[i] @= <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    model.sim_eval_combinational()  <span class="comment"># 计算组合逻辑</span></span><br><span class="line">    <span class="keyword">if</span> opts.trace:  <span class="comment"># 如果启用行跟踪</span></span><br><span class="line">        model.print_line_trace()  <span class="comment"># 打印行跟踪信息</span></span><br><span class="line">    model.sim_tick()  <span class="comment"># 模拟器前进一个时钟周期</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --------------------------</span></span><br><span class="line"><span class="comment"># 4. 报告统计数据</span></span><br><span class="line"><span class="comment"># --------------------------</span></span><br><span class="line"><span class="keyword">if</span> opts.stats:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"num_cycles = <span class="subst">{model.ncycles}</span>"</span>)  <span class="comment"># 总时钟周期数</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"num_cycles_per_sort = <span class="subst">{model.ncycles / ninputs:<span class="number">.2</span>f}</span>"</span>)  <span class="comment"># 每次排序的平均周期数</span></span><br></pre></td></tr></table></figure></div>

<p>代码详解</p>
<ol>
<li>生成输入数据集</li>
</ol>
<ul>
<li>根据<code>--input</code>命令行参数生成输入数据：</li>
<li>随机模式（random）：每组数据包含4个随机数，范围为[0, 255]。</li>
<li>升序模式（sorted-fwd）：生成升序排列的输入数据。</li>
<li>降序模式（sorted-rev）：生成降序排列的输入数据。</li>
<li>可以通过修改<code>ninputs</code>变量调整数据集大小。</li>
</ul>
<ol start="2">
<li>实例化并展开模型</li>
</ol>
<ul>
<li>使用字典<code>model_impl_dict</code>映射命令行参数到模型类，实现灵活切换模型：</li>
<li><code>cl</code>模型：周期近似模型，快速模拟排序行为。</li>
<li><code>rtl-flat</code>模型：平面RTL模型，直接实现硬件行为。</li>
<li><code>rtl-struct</code>模型：结构化RTL模型，通过层次化结构实现更高的代码复用性。</li>
</ul>
<p>配置选项包括：</p>
<ul>
<li>是否生成波形文件（<code>--dump-vcd</code>）。</li>
<li>是否进行Verilog测试（<code>--test-verilog</code>）。</li>
</ul>
<ol start="3">
<li>执行主循环</li>
</ol>
<ul>
<li>模拟器通过主循环驱动设计，记录输出有效信号并计算性能统计数据。</li>
</ul>
<p>输入处理逻辑：</p>
<ul>
<li>如果输入队列非空，则弹出一组数据，驱动输入端口。</li>
<li>如果输入队列为空，则设置输入信号为无效。</li>
</ul>
<p>输出处理逻辑：</p>
<ul>
<li>检测<code>out_val</code>信号，统计输出次数。</li>
</ul>
<p>调用流程：</p>
<ul>
<li><code>sim_eval_combinational()</code>：更新组合逻辑。</li>
<li><code>sim_tick()</code>：前进一个时钟周期。</li>
</ul>
<ol start="4">
<li>统计结果输出</li>
</ol>
<ul>
<li>模拟器通过<code>--stats</code>选项输出以下统计信息：</li>
<li>总时钟周期数（<code>num_cycles</code>）：完成所有数据处理所需的总周期数。</li>
<li>平均每次排序的周期数（<code>num_cycles_per_sort</code>）：衡量设计的吞吐量。</li>
</ul>
<p>命令行参数使用示例</p>
<ol>
<li>评估不同实现模型</li>
</ol>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">${TUTROOT}</span>/build</span><br><span class="line">../tut3_pymtl/sort/sort-sim --stats --impl cl         <span class="comment"># 周期近似模型</span></span><br><span class="line">../tut3_pymtl/sort/sort-sim --stats --impl rtl-flat   <span class="comment"># 平面RTL模型</span></span><br><span class="line">../tut3_pymtl/sort/sort-sim --stats --impl rtl-struct <span class="comment"># 结构化RTL模型</span></span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li>使用不同的输入数据集</li>
</ol>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">../tut3_pymtl/sort/sort-sim --stats --impl cl --input random       <span class="comment"># 随机输入</span></span><br><span class="line">../tut3_pymtl/sort/sort-sim --stats --impl cl --input sorted-fwd   <span class="comment"># 升序输入</span></span><br><span class="line">../tut3_pymtl/sort/sort-sim --stats --impl cl --input sorted-rev   <span class="comment"># 降序输入</span></span><br></pre></td></tr></table></figure></div>

<ol start="3">
<li>生成行跟踪和波形文件</li>
</ol>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../tut3_pymtl/sort/sort-sim --stats --impl rtl-struct --trace --dump-vcd</span><br></pre></td></tr></table></figure></div>

<p>注意事项</p>
<ol>
<li>模拟器与单元测试的区别：</li>
</ol>
<ul>
<li>模拟器：关注设计的性能指标，例如吞吐量和延迟。</li>
<li>单元测试：验证设计的功能正确性。</li>
</ul>
<ol start="2">
<li>流水线启动开销：</li>
</ol>
<ul>
<li>模拟结果显示，每次排序的平均时钟周期略高于1，这是由于流水线启动阶段的开销。</li>
</ul>
<ol start="3">
<li>设计验证与性能评估的分离：</li>
</ol>
<ul>
<li>模拟器假定设计功能正确，所有功能验证工作应在测试阶段完成。</li>
</ul>
<h3 id="5-6-将排序单元的-RTL-模型翻译为-Verilog"><a href="#5-6-将排序单元的-RTL-模型翻译为-Verilog" class="headerlink" title="5.6 将排序单元的 RTL 模型翻译为 Verilog"></a>5.6 将排序单元的 RTL 模型翻译为 Verilog</h3><p>完成从功能级（FL）模型到周期级（CL）模型，再到寄存器传输级（RTL）模型的逐步细化设计后，我们需要将RTL模型翻译为硬件描述语言（HDL），如Verilog或SystemVerilog。</p>
<p>PyMTL3框架提供了强大的翻译功能，支持从RTL模型到Verilog的转换，同时保持模型的层次性和可读性。</p>
<p><strong>翻译流程</strong></p>
<ol>
<li>基本翻译实现</li>
</ol>
<p>翻译流程通过<code>VerilogTranslationPass</code>实现，以下是关键步骤：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入相关模块</span></span><br><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pymtl3.passes.backends.verilog <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tut3_pymtl.sort <span class="keyword">import</span> SortUnitFlatRTL</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建RTL模型实例</span></span><br><span class="line">model = SortUnitFlatRTL()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用Verilog翻译功能</span></span><br><span class="line">model.set_metadata(VerilogTranslationPass.enable, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用Verilog翻译</span></span><br><span class="line">model.apply(VerilogTranslationPass())</span><br></pre></td></tr></table></figure></div>

<p>运行上述代码后，PyMTL3将生成翻译后的Verilog代码。</p>
<ol start="2">
<li>输出文件</li>
</ol>
<p>文件命名：<code>SortUnitFlatRTL__nbits_8__pickled.v</code>。</p>
<ul>
<li>文件名包含模型的参数信息（如<code>nbits=8</code>），确保不同参数化实例的模块名唯一。</li>
</ul>
<p>文件内容：</p>
<ul>
<li>翻译生成的Verilog代码保留了模块层次。</li>
<li><code>update_ff</code>块翻译为<code>always_ff</code>块。</li>
<li><code>update</code>块翻译为<code>always_comb</code>块。</li>
<li>每个并发块的PyMTL3代码会以注释形式保留在Verilog代码中，方便调试。</li>
</ul>
<ol start="3">
<li>代码特点</li>
</ol>
<ul>
<li>层次保留：翻译工具保留了模型的模块层次结构，如子模块实例化。</li>
<li>易读性：通过名称修饰规则（name mangling），生成的Verilog代码具有良好的可读性。</li>
</ul>
<p>翻译优化：</p>
<ul>
<li>翻译结果支持缓存机制，避免重复翻译相同模型。</li>
<li>在调试过程中可通过注释和层次结构快速定位问题。</li>
</ul>
<p><strong>高级翻译功能</strong></p>
<p>PyMTL3提供了VerilogTranslationImportPass，其功能远超简单的Verilog代码生成。它可以<br>    1.	翻译RTL模型为Verilog。<br>    2.	使用Verilator工具将Verilog代码转换为C++。<br>    3.	生成C++包装器，用于调用Verilog的C++仿真。<br>    4.	创建PyMTL3包装器，将C++包装器嵌入PyMTL3模型，形成一个精确的周期级硬件模拟器。</p>
<p>这一流程允许在PyMTL3中无缝调用翻译后的Verilog，同时使用相同的测试脚本验证模型功能。</p>
<p>翻译后可以进行模型测试。以下是一个支持翻译后模型测试的单元测试脚本示例：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymtl3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pymtl3.passes.backends.verilog <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pymtl3.stdlib.test_utils <span class="keyword">import</span> config_model_with_cmdline_opts</span><br><span class="line"><span class="keyword">from</span> ..SortUnitFlatRTL <span class="keyword">import</span> SortUnitFlatRTL</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_verilate</span>(<span class="params">cmdline_opts</span>):</span><br><span class="line">    <span class="comment"># 配置模型，启用dump_vcd和test_verilog选项</span></span><br><span class="line">    model = SortUnitFlatRTL(<span class="number">8</span>)</span><br><span class="line">    model = config_model_with_cmdline_opts(model, cmdline_opts, duts=[])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建并重置模拟器</span></span><br><span class="line">    model.apply(DefaultPassGroup(linetrace=<span class="literal">True</span>))</span><br><span class="line">    model.sim_reset()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 辅助函数：设置输入并验证输出</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">t</span>(<span class="params">in_val, in_, out_val, out</span>):</span><br><span class="line">        model.in_val @= in_val</span><br><span class="line">        <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(in_):</span><br><span class="line">            model.in_[i] @= v</span><br><span class="line">        model.sim_eval_combinational()</span><br><span class="line">        <span class="keyword">assert</span> model.out_val == out_val</span><br><span class="line">        <span class="keyword">if</span> out_val:</span><br><span class="line">            <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(out):</span><br><span class="line">                <span class="keyword">assert</span> model.out[i] == v</span><br><span class="line">        model.sim_tick()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试用例</span></span><br><span class="line">    t(<span class="number">0</span>, [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>], <span class="number">0</span>, [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>])</span><br><span class="line">    t(<span class="number">1</span>, [<span class="number">0x03</span>, <span class="number">0x09</span>, <span class="number">0x04</span>, <span class="number">0x01</span>], <span class="number">0</span>, [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>])</span><br><span class="line">    t(<span class="number">1</span>, [<span class="number">0x10</span>, <span class="number">0x23</span>, <span class="number">0x02</span>, <span class="number">0x41</span>], <span class="number">0</span>, [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>])</span><br><span class="line">    t(<span class="number">1</span>, [<span class="number">0x02</span>, <span class="number">0x55</span>, <span class="number">0x13</span>, <span class="number">0x07</span>], <span class="number">0</span>, [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>])</span><br><span class="line">    t(<span class="number">0</span>, [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>], <span class="number">1</span>, [<span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x04</span>, <span class="number">0x09</span>])</span><br><span class="line">    t(<span class="number">0</span>, [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>], <span class="number">1</span>, [<span class="number">0x02</span>, <span class="number">0x10</span>, <span class="number">0x23</span>, <span class="number">0x41</span>])</span><br><span class="line">    t(<span class="number">0</span>, [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>], <span class="number">1</span>, [<span class="number">0x02</span>, <span class="number">0x07</span>, <span class="number">0x13</span>, <span class="number">0x55</span>])</span><br><span class="line">    t(<span class="number">0</span>, [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>], <span class="number">0</span>, [<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>])</span><br></pre></td></tr></table></figure></div>

<p>以下是运行测试的命令：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试PyMTL3 RTL模型</span></span><br><span class="line">pytest ../tut3_pymtl/sort/test/SortUnitFlatRTL_v_test.py --dump-vcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试翻译后的Verilog模型</span></span><br><span class="line">pytest ../tut3_pymtl/sort/test/SortUnitFlatRTL_v_test.py --dump-vcd --test-verilog</span><br></pre></td></tr></table></figure></div>

<p>测试过程中会生成多个波形文件（VCD文件），包括：</p>
<ul>
<li>sort-pymtl.vcd：用于测试原始PyMTL3 RTL模型。</li>
<li>测试翻译后的Verilog模型的波形文件（两个VCD文件分别对应PyMTL3包装器和实际Verilog设计）。</li>
</ul>
<p>最终，我们可以使用模拟器脚本生成排序单元的Verilog代码和波形文件，这些文件可用于FPGA或ASIC工具链。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">../tut3_pymtl/sort/sort-sim --impl rtl-flat --input random --translate --dump-vcd</span><br><span class="line">../tut3_pymtl/sort/sort-sim --impl rtl-flat --input sorted-fwd --translate --dump-vcd</span><br><span class="line">../tut3_pymtl/sort/sort-sim --impl rtl-flat --input sorted-rev --translate --dump-vcd</span><br></pre></td></tr></table></figure></div>

        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> PyMTL基础入门</li>
        <li><strong>Author:</strong> Albert Cheung</li>
        <li><strong>Created at
                :</strong> 2024-11-07 20:20:39</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-11-25 17:42:36
            </li>
        
        <li>
            <strong>Link:</strong> https://www.albertc9.github.io/2024/11/07/introduction-to-pymtl-basics/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/Notes/">#Notes</a>&nbsp;
                    </li>
                
            </ul>
        

        
  <div class="recommended-article px-2 sm:px-6 md:px-8">
   <div class="recommended-desktop">
    <div class="recommended-article-header text-xl md:text-3xl font-bold mt-10">
     <i aria-hidden="true"></i><span>推荐阅读</span>
    </div>
    <div class="recommended-article-group"><a class="recommended-article-item" href="/2024/11/07/introduction-to-python-basics/" title="Python基础入门" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="Python基础入门" class="!max-w-none">
  <span class="title">Python基础入门</span>
</a><a class="recommended-article-item" href="/2025/02/03/introduction-to-verilog-hdl-basics/" title="Verilog HDL 基础入门" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="Verilog HDL 基础入门" class="!max-w-none">
  <span class="title">Verilog HDL 基础入门</span>
</a><a class="recommended-article-item" href="/2024/12/04/introduction-to-asic-design/" title="使用 Synopsys 和 Cadence 工具的 ASIC 设计流程 (Temporarily Stop Updating)" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="使用 Synopsys 和 Cadence 工具的 ASIC 设计流程 (Temporarily Stop Updating)" class="!max-w-none">
  <span class="title">使用 Synopsys 和 Cadence 工具的 ASIC 设计流程 (Temporarily Stop Updating)</span>
</a></div>
   </div>
   <div class="recommended-mobile">
   <div class="recommended-article-header text-xl md:text-3xl font-bold mt-10">
     <i aria-hidden="true"></i><span>推荐阅读</span>
   </div>
   <div class="recommended-article-group"><a class="recommended-article-item" href="/2024/11/07/introduction-to-python-basics/" title="Python基础入门" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="Python基础入门" class="!max-w-none">
  <span class="title">Python基础入门</span>
</a><a class="recommended-article-item" href="/2025/02/03/introduction-to-verilog-hdl-basics/" title="Verilog HDL 基础入门" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="Verilog HDL 基础入门" class="!max-w-none">
  <span class="title">Verilog HDL 基础入门</span>
</a></div>
   </div>
  </div>

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2024/12/04/introduction-to-asic-design/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">使用 Synopsys 和 Cadence 工具的 ASIC 设计流程 (Temporarily Stop Updating)</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2024/11/07/introduction-to-python-basics/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Python基础入门</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">PyMTL基础入门</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC01%E7%AB%A0-%E7%AE%80%E4%BB%8B"><span class="nav-text">第01章 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC02%E7%AB%A0-PyMTL3-%E7%9A%84%E5%8A%9F%E8%83%BD%E7%BA%A7%E3%80%81%E5%91%A8%E6%9C%9F%E7%BA%A7%E5%92%8C%E5%AF%84%E5%AD%98%E5%99%A8%E4%BC%A0%E8%BE%93%E7%BA%A7%E5%BB%BA%E6%A8%A1"><span class="nav-text">第02章 PyMTL3 的功能级、周期级和寄存器传输级建模</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-FL%E3%80%81CL-%E5%92%8C-RTL-%E5%BB%BA%E6%A8%A1%E6%AF%94%E8%BE%83"><span class="nav-text">2.1 FL、CL 和 RTL 建模比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%8F%AF%E7%BB%BC%E5%90%88%E4%B8%8E%E9%9D%9E%E5%8F%AF%E7%BB%BC%E5%90%88-RTL-%E5%BB%BA%E6%A8%A1"><span class="nav-text">2.2 可综合与非可综合 RTL 建模</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC03%E7%AB%A0-PyMTL3%E5%9F%BA%E7%A1%80%EF%BC%9A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%92%8C%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="nav-text">第03章 PyMTL3基础：数据类型和操作符</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Bits%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-text">3.1 Bits数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Bits%E6%93%8D%E4%BD%9C%E7%AC%A6-Bits-Operators"><span class="nav-text">3.2 Bits操作符(Bits Operators)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-BitStruct-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-text">3.3 BitStruct 数据类型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC04%E7%AB%A0-%E5%AF%84%E5%AD%98%E5%A2%9E%E9%87%8F%E5%99%A8-Registered-Incrementer"><span class="nav-text">第04章 寄存增量器(Registered Incrementer)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E5%BB%BA%E6%A8%A1%E5%AF%84%E5%AD%98%E5%A2%9E%E9%87%8F%E5%99%A8"><span class="nav-text">4.1 建模寄存增量器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E6%A8%A1%E6%8B%9F%E6%A8%A1%E5%9E%8B"><span class="nav-text">4.2 模拟模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-text">4.3 可视化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%E4%BD%BF%E7%94%A8pytest%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81%E6%A8%A1%E5%9E%8B"><span class="nav-text">4.4 使用pytest进行单元测试验证模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-%E4%BD%BF%E7%94%A8%E6%B5%8B%E8%AF%95%E5%90%91%E9%87%8F%E9%AA%8C%E8%AF%81%E6%A8%A1%E5%9E%8B"><span class="nav-text">4.5 使用测试向量验证模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-%E4%BD%BF%E7%94%A8%E9%9A%8F%E6%9C%BA%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81%E6%A8%A1%E5%9E%8B"><span class="nav-text">4.6 使用随机测试验证模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-7-%E4%B8%A4%E7%BA%A7%E5%AF%84%E5%AD%98%E9%80%92%E5%A2%9E%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%B5%8B%E8%AF%95"><span class="nav-text">4.7 两级寄存递增器的设计与测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-8-%E4%BD%BF%E7%94%A8%E2%80%9C%E9%9D%99%E6%80%81%E2%80%9D%E5%B1%95%E5%BC%80%E8%BF%9B%E8%A1%8C%E7%BB%84%E4%BB%B6%E5%8F%82%E6%95%B0%E5%8C%96"><span class="nav-text">4.8 使用“静态”展开进行组件参数化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-9-%E6%89%93%E5%8C%85%E6%A8%A1%E5%9E%8B%E9%9B%86%E5%90%88"><span class="nav-text">4.9 打包模型集合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC05%E7%AB%A0-%E6%8E%92%E5%BA%8F%E5%8D%95%E5%85%83-Sort-Unit"><span class="nav-text">第05章 排序单元(Sort Unit)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E6%8E%92%E5%BA%8F%E5%8D%95%E5%85%83%E7%9A%84-FL-%E6%A8%A1%E5%9E%8B"><span class="nav-text">5.1 排序单元的 FL 模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E6%8E%92%E5%BA%8F%E5%8D%95%E5%85%83%E7%9A%84-CL-%E6%A8%A1%E5%9E%8B"><span class="nav-text">5.2 排序单元的 CL 模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E6%8E%92%E5%BA%8F%E5%8D%95%E5%85%83%E7%9A%84-RTL-%E6%A8%A1%E5%9E%8B"><span class="nav-text">5.3 排序单元的 RTL 模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-%E5%9F%BA%E4%BA%8E%E7%BB%93%E6%9E%84%E5%8C%96-RTL-%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%8E%92%E5%BA%8F%E5%8D%95%E5%85%83"><span class="nav-text">5.4 基于结构化 RTL 模型的排序单元</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-%E4%BD%BF%E7%94%A8%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%AF%84%E4%BC%B0%E6%8E%92%E5%BA%8F%E5%8D%95%E5%85%83"><span class="nav-text">5.5 使用模拟器评估排序单元</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-%E5%B0%86%E6%8E%92%E5%BA%8F%E5%8D%95%E5%85%83%E7%9A%84-RTL-%E6%A8%A1%E5%9E%8B%E7%BF%BB%E8%AF%91%E4%B8%BA-Verilog"><span class="nav-text">5.6 将排序单元的 RTL 模型翻译为 Verilog</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
            <div class="customize-info my-1">v1.3.2</div>
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-cog fa-spin" style="--fa-animation-duration: 15s;"></i>&nbsp;&nbsp;<a href="/">Albert Cheung</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        38 posts in total
                    </span>
                    
                        <span>
                            232.9k words in total
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.7.3</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>


    <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/libs/Swup.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/libs/SwupSlideTheme.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/libs/SwupScriptsPlugin.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/libs/SwupProgressPlugin.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/libs/SwupScrollPlugin.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/libs/SwupPreloadPlugin.min.js" ></script>
<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>






<script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/tools/imageViewer.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/utils.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/main.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/layouts/navbarShrink.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/tools/scrollTopBottom.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/tools/lightDarkSwitch.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/layouts/categoryList.js" ></script>


    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/tools/localSearch.js" ></script>



    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/tools/codeBlock.js" ></script>



    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/layouts/lazyload.js" ></script>



    <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/tools/runtime.js" ></script>
    <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/libs/odometer.min.js" ></script>
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/assets/odometer-theme-minimal.css">



  <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/libs/Typed.min.js" ></script>
  <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/plugins/typed.js" ></script>










    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/tools/tocToggle.js" data-swup-reload-script></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/layouts/toc.js" data-swup-reload-script></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/plugins/tabs.js" data-swup-reload-script></script>


<script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/libs/moment-with-locales.min.js" data-swup-reload-script></script>
<script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.7.3/files/source/js/layouts/essays.js" data-swup-reload-script></script>



</body>
</html>
